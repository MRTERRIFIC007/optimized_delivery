<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delivery Prediction System</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸšš</text></svg>"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        padding-top: 20px;
      }
      .prediction-result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        background-color: #f8f9fa;
      }
      .time-badge {
        font-size: 1.1em;
        margin: 0 5px;
        padding: 5px 10px;
      }
      .failure-rate {
        font-size: 0.9em;
        display: block;
        margin-top: 5px;
      }
      .order-card {
        margin-bottom: 15px;
      }
      .route-segment {
        padding: 10px;
        margin-bottom: 10px;
        border-left: 3px solid #0d6efd;
        background-color: #f8f9fa;
      }
      .route-map {
        height: 400px;
        width: 100%;
        border-radius: 5px;
        margin-top: 15px;
      }
      .customer-address {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 3px;
      }
      .checkout-container {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
      }
      /* Leaflet custom styles */
      #map {
        height: 400px;
        width: 100%;
        border-radius: 5px;
      }
      .custom-div-icon div {
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .leaflet-popup-content {
        margin: 10px;
      }
      .leaflet-popup-content-wrapper {
        border-radius: 5px;
      }
      .route-summary {
        font-size: 14px;
      }
      /* Hide Leaflet Routing Machine control panel but keep the route */
      .leaflet-routing-container {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4">Delivery Prediction System</h1>

      <div class="row">
        <!-- Left Column -->
        <div class="col-md-6">
          <!-- Prediction Section -->
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h4>Predict Optimal Delivery Times</h4>
            </div>
            <div class="card-body">
              <form id="predictionForm">
                <div class="mb-3">
                  <label for="name" class="form-label">Customer Name:</label>
                  <select class="form-select" id="name" name="name" required>
                    <option value="" selected disabled>
                      Select a customer
                    </option>
                    {% for name in names %}
                    <option value="{{ name }}">{{ name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="day" class="form-label">Day of Delivery:</label>
                  <select class="form-select" id="day" name="day">
                    <option value="{{ current_day }}" selected>
                      Today ({{ current_day }})
                    </option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                  </select>
                </div>

                <button type="submit" class="btn btn-primary">
                  Predict Optimal Times
                </button>
              </form>

              <div
                id="predictionResult"
                class="prediction-result"
                style="display: none"
              >
                <h5>
                  Optimal Delivery Times for <span id="customerName"></span> on
                  <span id="deliveryDay"></span>:
                </h5>
                <div id="optimalTimes" class="mt-3"></div>
              </div>
            </div>
          </div>

          <!-- Add New Order -->
          <div class="card mt-4">
            <div class="card-header bg-success text-white">
              <h4>Add New Order</h4>
            </div>
            <div class="card-body">
              <form id="newOrderForm">
                <div class="mb-3">
                  <label for="order_name" class="form-label"
                    >Customer Name:</label
                  >
                  <select
                    class="form-select"
                    id="order_name"
                    name="name"
                    required
                    onchange="updateAreaInfo()"
                  >
                    <option value="" selected disabled>
                      Select a customer
                    </option>
                    <option value="Aditya">Aditya (Satellite)</option>
                    <option value="Vivaan">Vivaan (Bopal)</option>
                    <option value="Aarav">Aarav (Vastrapur)</option>
                    <option value="Meera">Meera (Paldi)</option>
                    <option value="Diya">Diya (Thaltej)</option>
                    <option value="Riya">Riya (Navrangpura)</option>
                    <option value="Ananya">Ananya (Bodakdev)</option>
                    <option value="Aryan">Aryan (Gota)</option>
                    <option value="Ishaan">Ishaan (Maninagar)</option>
                    <option value="Kabir">Kabir (Chandkheda)</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="delivery_day" class="form-label"
                    >Day of Delivery:</label
                  >
                  <select
                    class="form-select"
                    id="delivery_day"
                    name="delivery_day"
                    required
                  >
                    <option value="{{ current_day }}">
                      Today ({{ current_day }})
                    </option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="customer_area" class="form-label">Area:</label>
                  <input
                    type="text"
                    class="form-control"
                    id="customer_area"
                    readonly
                    disabled
                  />
                  <small class="text-muted"
                    >Area is automatically assigned based on the customer</small
                  >
                </div>

                <div class="mb-3">
                  <label for="package_size" class="form-label"
                    >Package Size:</label
                  >
                  <select
                    class="form-select"
                    id="package_size"
                    name="package_size"
                    required
                  >
                    <option value="Small">Small</option>
                    <option value="Medium">Medium</option>
                    <option value="Large">Large</option>
                  </select>
                </div>

                <button type="submit" class="btn btn-success">Add Order</button>
              </form>

              <div
                id="orderResult"
                class="alert alert-success mt-3"
                style="display: none"
              >
                Order added successfully!
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-6">
          <!-- Route Optimization Section -->
          <div class="card mb-4">
            <div class="card-header bg-info text-white">
              <h4>Route Optimization</h4>
            </div>
            <div class="card-body">
              <p>Plan the most efficient delivery route for today's orders.</p>

              <form id="routeOptimizationForm">
                <div class="mb-3">
                  <label class="form-label"
                    >Select Customers for Today's Delivery Route:</label
                  >
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="selectAllCustomers"
                    />
                    <label class="form-check-label" for="selectAllCustomers">
                      Select All Today's Orders
                    </label>
                  </div>

                  <div id="todaysOrdersList" class="mt-2">
                    {% for order in grouped_todays_orders %}
                    <div class="form-check">
                      <input
                        class="form-check-input customer-checkbox"
                        type="checkbox"
                        name="selected_customers[]"
                        value="{{ order.name }}"
                        id="customer-{{ order.order_id }}"
                        data-count="{{ order.parcel_count }}"
                      />
                      <label
                        class="form-check-label"
                        for="customer-{{ order.order_id }}"
                      >
                        {{ order.name }} ({{ order.area }}) {% if
                        order.parcel_count > 1 %}
                        <span class="badge bg-primary"
                          >{{ order.parcel_count }} parcels</span
                        >
                        {% endif %}
                        <div class="customer-address">{{ order.address }}</div>
                      </label>
                    </div>
                    {% endfor %}
                  </div>
                </div>

                <button type="submit" class="btn btn-info">
                  Optimize Route
                </button>
              </form>

              <div
                id="routeLoadingIndicator"
                class="text-center my-4"
                style="display: none"
              >
                <div class="spinner-border text-info" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Calculating optimal delivery route...</p>
              </div>

              <div id="routeResult" class="mt-4" style="display: none">
                <h5 id="routeSummary" class="mb-3">Optimal Delivery Route:</h5>

                <div id="distance-container" class="alert alert-info">
                  <strong>Total Distance:</strong>
                  <span id="total-distance"></span> km
                </div>

                <div id="map" class="route-map mb-3"></div>

                <div id="route-details" class="mt-4">
                  <h5>Route Details</h5>
                  <div id="route-stops">
                    <!-- Table will be inserted here by JavaScript -->
                  </div>
                </div>

                <div class="mt-3 text-end">
                  <button id="resetRouteBtn" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-counterclockwise"></i> Plan New Route
                  </button>
                  <button id="returnToStart" class="btn btn-primary">
                    <i class="bi bi-house"></i> Return to Start
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Pending Orders -->
          <div class="card">
            <div
              class="card-header bg-warning d-flex justify-content-between align-items-center"
            >
              <h4>Pending Orders ({{ pending_orders|length }})</h4>
              <button
                id="scheduleSelectedBtn"
                class="btn btn-sm btn-primary"
                style="display: none"
              >
                <i class="bi bi-calendar-check"></i> Schedule Selected Orders
              </button>
            </div>
            <div class="card-body">
              <!-- Hidden form for scheduling orders -->
              <form id="scheduleOrdersForm" style="display: none">
                <div id="selectedOrdersContainer"></div>
              </form>

              <div class="list-group" id="ordersContainer">
                {% for group in grouped_pending_orders %}
                <div class="card order-card">
                  <div class="card-body">
                    <h5 class="card-title">
                      {{ group.name }} {% if group.orders|length > 1 %}
                      <span class="badge bg-primary"
                        >{{ group.orders|length }} parcels</span
                      >
                      {% endif %}
                    </h5>
                    <p class="card-text">
                      <strong>Delivery Day:</strong> {{ group.delivery_day }}<br />
                      <strong>Area:</strong> {{ group.area }}<br />
                      <strong>Address:</strong> {{ group.address }}<br />
                    </p>
                    <div class="mt-3">
                      <strong>Parcels:</strong>
                      <ul class="list-group mt-2">
                        {% for order in group.orders %}
                        <li
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>#{{ order.order_id }}</strong> - {{
                            order.package_size }} package
                            <span class="badge bg-warning ms-2"
                              >{{ order.status|default('Pending') }}</span
                            >
                            <div class="form-check form-check-inline ms-2">
                              <input
                                class="form-check-input schedule-checkbox"
                                type="checkbox"
                                value="{{ order.order_id }}"
                                id="schedule-{{ order.order_id }}"
                                data-order-id="{{ order.order_id }}"
                                data-customer-name="{{ order.name }}"
                                data-area="{{ order.area }}"
                              />
                              <label
                                class="form-check-label"
                                for="schedule-{{ order.order_id }}"
                              >
                                Schedule for today
                              </label>
                            </div>
                          </div>
                          <div class="btn-group" role="group">
                            <a
                              href="/mark_delivered/{{ order.order_id }}?success=true"
                              class="btn btn-success btn-sm"
                              >Delivered</a
                            >
                            <a
                              href="/mark_delivered/{{ order.order_id }}?success=false"
                              class="btn btn-danger btn-sm"
                              >Failed</a
                            >
                          </div>
                        </li>
                        {% endfor %}
                      </ul>
                    </div>
                    {% if current_day != group.delivery_day %}
                    <div class="d-grid gap-2 mt-3">
                      <button
                        class="btn btn-primary schedule-for-today-btn"
                        data-group-orders="{{ group.orders|map(attribute='order_id')|list|tojson }}"
                        data-group-name="{{ group.name }}"
                      >
                        <i class="bi bi-calendar-check"></i> Schedule All for
                        Today ({{ current_day }})
                      </button>
                    </div>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Chatbot Component -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div
              class="card-header bg-dark text-white d-flex justify-content-between align-items-center"
            >
              <h4>
                <i class="bi bi-chat-dots-fill me-2"></i> Delivery Assistant
              </h4>
              <button id="chatMinimize" class="btn btn-sm btn-outline-light">
                <i class="bi bi-dash-lg"></i>
              </button>
            </div>
            <div class="card-body" id="chatBody">
              <div
                id="chatMessages"
                class="mb-3"
                style="
                  height: 300px;
                  overflow-y: auto;
                  border: 1px solid #dee2e6;
                  border-radius: 5px;
                  padding: 10px;
                "
              >
                <div class="alert alert-info">
                  <i class="bi bi-robot me-2"></i> Hello! I'm your delivery
                  assistant. How can I help you today?
                </div>
              </div>

              <form id="chatForm" class="d-flex">
                <input
                  type="text"
                  id="chatInput"
                  class="form-control me-2"
                  placeholder="Ask me about deliveries, routes, or customers..."
                />
                <button type="submit" class="btn btn-dark">
                  <i class="bi bi-send-fill"></i>
                </button>
              </form>

              <div class="mt-2 text-muted small">
                <i class="bi bi-info-circle me-1"></i> Try asking about optimal
                delivery times, today's deliveries, or specific customers
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script>
      // Function to geocode address using Nominatim
      function geocodeAddress(address) {
        return new Promise((resolve, reject) => {
          const encodedAddress = encodeURIComponent(address);
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1`;

          fetch(url, {
            headers: {
              Accept: "application/json",
              "User-Agent": "DeliveryPredictionSystem/1.0",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data && data.length > 0) {
                const result = data[0];
                resolve([parseFloat(result.lat), parseFloat(result.lon)]);
              } else {
                reject(new Error("Address not found"));
              }
            })
            .catch((error) => {
              console.error("Geocoding error:", error);
              reject(error);
            });
        });
      }

      // Customer area mapping
      const customerAreas = {
        Aditya: "Satellite",
        Vivaan: "Bopal",
        Aarav: "Vastrapur",
        Meera: "Paldi",
        Diya: "Thaltej",
        Riya: "Navrangpura",
        Ananya: "Bodakdev",
        Aryan: "Gota",
        Ishaan: "Maninagar",
        Kabir: "Chandkheda",
      };

      function updateAreaInfo() {
        const customerName = document.getElementById("order_name").value;
        const areaField = document.getElementById("customer_area");

        if (customerName && customerAreas[customerName]) {
          areaField.value = customerAreas[customerName];
        } else {
          areaField.value = "";
        }
      }

      $(document).ready(function () {
        // Store current day for use in JavaScript
        const currentDay = "{{ current_day }}";

        // Initialize area display
        updateAreaInfo();

        // Check if we have a scheduled route to display after page reload
        if (localStorage.getItem("scheduleSuccess") === "true") {
          try {
            const scheduledRouteJson = localStorage.getItem("scheduledRoute");
            if (!scheduledRouteJson) {
              throw new Error("Missing scheduled route data");
            }

            const scheduledRoute = JSON.parse(scheduledRouteJson);

            if (
              !scheduledRoute ||
              !scheduledRoute.route ||
              !Array.isArray(scheduledRoute.route) ||
              scheduledRoute.route.length === 0
            ) {
              throw new Error("Invalid scheduled route data format");
            }

            // Clear the success flag
            localStorage.removeItem("scheduleSuccess");
            localStorage.removeItem("scheduledRoute");

            // Auto-check the customer checkboxes based on the route
            $("#selectAllCustomers").prop("checked", true);
            $(".customer-checkbox").each(function () {
              try {
                // Get customer name from the checkbox
                const customerName = $(this).val();
                if (!customerName) return;

                // Check if this customer is in the route
                if (
                  scheduledRoute.route.some(
                    (routeItem) =>
                      routeItem &&
                      typeof routeItem === "string" &&
                      routeItem.startsWith(customerName)
                  )
                ) {
                  $(this).prop("checked", true);
                }
              } catch (checkboxError) {
                console.error(
                  "Error checking customer checkbox:",
                  checkboxError
                );
              }
            });

            // Show loading indicator briefly
            $("#routeLoadingIndicator").show();

            // Display the optimized route after a short delay
            setTimeout(function () {
              $("#routeLoadingIndicator").hide();
              try {
                displayOptimizedRoute(scheduledRoute);
              } catch (displayError) {
                console.error(
                  "Error displaying scheduled route:",
                  displayError
                );
                alert(
                  "Error displaying the scheduled route. Please try again."
                );
              }

              // Scroll to the route result
              try {
                if ($("#routeResult").is(":visible")) {
                  $("html, body").animate(
                    {
                      scrollTop: $("#routeResult").offset().top - 50,
                    },
                    500
                  );
                }
              } catch (scrollError) {
                console.error("Error scrolling to route result:", scrollError);
              }
            }, 500);
          } catch (error) {
            console.error("Error processing scheduled route:", error);
            localStorage.removeItem("scheduleSuccess");
            localStorage.removeItem("scheduledRoute");
          }
        }

        // Reset route planning
        $(document).on("click", "#resetRouteBtn", function () {
          // Clear checkboxes
          $(".customer-checkbox").prop("checked", false);
          $("#selectAllCustomers").prop("checked", false);

          // Hide route result
          $("#routeResult").hide();

          // Scroll back to the form
          $("html, body").animate(
            {
              scrollTop: $("#routeOptimizationForm").offset().top - 20,
            },
            500
          );
        });

        // Prediction form submission
        $("#predictionForm").submit(function (e) {
          e.preventDefault();

          $.ajax({
            url: "/predict",
            type: "POST",
            data: $(this).serialize(),
            success: function (response) {
              $("#customerName").text(response.name);
              $("#deliveryDay").text(response.day);

              let timesHtml = "";
              response.optimal_times.forEach(function (prediction) {
                if (typeof prediction === "object") {
                  timesHtml += `
                    <div class="mb-2">
                      <span class="badge bg-primary time-badge">${prediction.time}</span>
                      <span class="badge bg-danger failure-rate">${prediction.failure_rate}% Failure Rate</span>
                    </div>
                  `;
                } else {
                  timesHtml += `<span class="badge bg-primary time-badge">${prediction}</span>`;
                }
              });

              $("#optimalTimes").html(timesHtml);
              $("#predictionResult").show();
            },
          });
        });

        // New order form submission
        $("#newOrderForm").submit(function (e) {
          e.preventDefault();

          $.ajax({
            url: "/add_order",
            type: "POST",
            data: $(this).serialize(),
            success: function (response) {
              $("#orderResult").show().delay(3000).fadeOut();
              setTimeout(function () {
                location.reload();
              }, 3000);
            },
          });
        });

        // Select/deselect all customers
        $("#selectAllCustomers").change(function () {
          $(".customer-checkbox").prop("checked", $(this).prop("checked"));
        });

        // Route optimization form submission
        $("#routeOptimizationForm").submit(function (e) {
          e.preventDefault();

          // Get selected customers with counts
          const selectedCustomers = [];
          $(".customer-checkbox:checked").each(function () {
            const customerName = $(this).val();
            const count = parseInt($(this).data("count") || 1);

            // Add the customer to the list based on the parcel count
            for (let i = 0; i < count; i++) {
              selectedCustomers.push(customerName);
            }
          });

          // Show loading indicator
          $("#routeLoadingIndicator").show();
          $("#routeResult").hide();

          // Build the form data
          const formData = new FormData();
          selectedCustomers.forEach((name) => {
            formData.append("selected_customers[]", name);
          });

          $.ajax({
            url: "/optimize_route",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
              // Hide loading indicator
              $("#routeLoadingIndicator").hide();

              // Display optimized route
              displayOptimizedRoute(response);
            },
            error: function (error) {
              // Hide loading indicator and show error
              $("#routeLoadingIndicator").hide();
              alert(
                "An error occurred while optimizing the route. Please try again."
              );
              console.error("Route optimization error:", error);
            },
          });
        });

        // Function to display the optimized route
        function displayOptimizedRoute(route) {
          // Check if route object is valid
          if (!route || typeof route !== "object") {
            console.error("Invalid route object:", route);
            alert("Failed to display route - invalid data received.");
            return;
          }

          // Show the route details section
          $("#route-details").show();
          $("#routeResult").show();

          // Update the route summary
          if (route.route && Array.isArray(route.route)) {
            $("#routeSummary").text(
              `Optimal delivery route with ${route.route.length - 1} stops`
            );
          } else {
            $("#routeSummary").text("Optimal delivery route");
          }

          // Clear previous route details
          $("#route-stops").empty();

          // Add each stop to the route details
          if (
            route.route &&
            Array.isArray(route.route) &&
            route.route.length > 0
          ) {
            // Start populating the table
            var tableHtml = `
                  <table class="table">
                      <thead>
                          <tr>
                              <th>#</th>
                              <th>Location</th>
                              <th>Area</th>
                              <th>Address</th>
                              <th>Distance</th>
                          </tr>
                      </thead>
                      <tbody>`;

            let stopNumber = 0;

            // Loop through each location in the route
            for (let i = 0; i < route.route.length; i++) {
              let location = route.route[i];
              let area =
                route.areas && route.areas[i] ? route.areas[i] : "Unknown";
              let address =
                route.addresses && route.addresses[i]
                  ? route.addresses[i]
                  : "Unknown";
              let distance =
                route.distances && route.distances[i]
                  ? route.distances[i] + " km"
                  : "";

              // Skip "Start Location (Postman)" in the count but still show it
              if (location.includes("Start Location")) {
                tableHtml += `
                          <tr class="table-primary">
                              <td><i class="bi bi-house-fill"></i></td>
                              <td>${location}</td>
                              <td>${area}</td>
                              <td>${address}</td>
                              <td>${distance}</td>
                          </tr>`;
              } else {
                stopNumber++;

                // Check if this is a customer with multiple parcels
                let parcelCount = 1;
                let displayName = location;

                if (location.includes(" (")) {
                  // Extract the parcel count if it exists
                  let match = location.match(/ \((\d+)\)/);
                  if (match && match[1]) {
                    parcelCount = parseInt(match[1]);
                  }

                  // Extract just the name portion
                  displayName = location.split(" (")[0];
                }

                tableHtml += `
                          <tr>
                              <td>${stopNumber}</td>
                              <td>${displayName}${
                  parcelCount > 1
                    ? ` <span class="badge bg-info">${parcelCount} parcels</span>`
                    : ""
                }</td>
                              <td>${area}</td>
                              <td>${address}</td>
                              <td>${distance}</td>
                          </tr>`;
              }
            }

            // Complete the table
            tableHtml += `
                      </tbody>
                  </table>`;

            // Add the table to the route-stops element
            $("#route-stops").html(tableHtml);

            // Show total distance if available
            if (route.total_distance) {
              $("#total-distance").text(route.total_distance);
              $("#distance-container").show();
            } else {
              $("#distance-container").hide();
            }

            // Initialize the map with the route
            try {
              initMap(route);
            } catch (error) {
              console.error("Error initializing map:", error);
            }
          } else {
            // Display message when no route is available
            $("#route-stops").html(
              '<div class="alert alert-warning">No valid route data available.</div>'
            );
            $("#distance-container").hide();
          }
        }

        // Initialize the map with the optimized route
        function initMap(routeData) {
          // Validate route data
          if (!routeData || typeof routeData !== "object") {
            console.error("Invalid route data passed to initMap:", routeData);
            return;
          }

          // Clear any existing map
          if (window.map) {
            try {
              window.map.remove();
            } catch (error) {
              console.error("Error removing existing map:", error);
            }
          }

          // Default center (Ahmedabad)
          const defaultCenter = [23.0225, 72.5714];

          // Initialize postman location (start location)
          let postmanLocation = defaultCenter;

          try {
            const startLocationName = "Start Location (Postman)";

            if (routeData.route && Array.isArray(routeData.route)) {
              const startIndex = routeData.route.findIndex(
                (loc) =>
                  loc &&
                  typeof loc === "string" &&
                  loc.includes(startLocationName)
              );

              if (
                startIndex !== -1 &&
                routeData.coordinates &&
                Array.isArray(routeData.coordinates) &&
                routeData.coordinates[startIndex]
              ) {
                // Get coordinates from the route data
                const rawCoords = routeData.coordinates[startIndex];
                if (
                  Array.isArray(rawCoords) &&
                  rawCoords.length === 2 &&
                  !isNaN(parseFloat(rawCoords[0])) &&
                  !isNaN(parseFloat(rawCoords[1]))
                ) {
                  postmanLocation = [
                    parseFloat(rawCoords[0]),
                    parseFloat(rawCoords[1]),
                  ];
                } else {
                  console.warn(
                    "Invalid start location coordinates, using default"
                  );
                }
              } else {
                console.warn(
                  "Start location not found in route, using default"
                );
              }
            } else {
              console.warn(
                "Route array is missing or invalid, using default location"
              );
            }
          } catch (error) {
            console.error("Error initializing postman location", error);
          }

          // Create the map
          try {
            window.map = L.map("map").setView(postmanLocation, 13);

            // Add the tile layer (OpenStreetMap)
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution:
                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            }).addTo(window.map);
          } catch (error) {
            console.error("Error creating map:", error);
            return;
          }

          // Prepare waypoints for the route
          const waypoints = [];
          const validLocations = [];

          // Process each location in the route
          if (
            routeData.route &&
            Array.isArray(routeData.route) &&
            routeData.coordinates &&
            Array.isArray(routeData.coordinates)
          ) {
            routeData.route.forEach((location, index) => {
              if (routeData.coordinates[index]) {
                const coords = routeData.coordinates[index];

                // Validate coordinates
                if (
                  location &&
                  typeof location === "string" &&
                  Array.isArray(coords) &&
                  coords.length === 2 &&
                  !isNaN(parseFloat(coords[0])) &&
                  !isNaN(parseFloat(coords[1]))
                ) {
                  const lat = parseFloat(coords[0]);
                  const lng = parseFloat(coords[1]);

                  // Add to waypoints for routing
                  waypoints.push(L.latLng(lat, lng));

                  // Store valid location data for markers
                  validLocations.push({
                    name: location,
                    coords: [lat, lng],
                    area:
                      routeData.areas && routeData.areas[index]
                        ? routeData.areas[index]
                        : "Unknown",
                    address:
                      routeData.addresses && routeData.addresses[index]
                        ? routeData.addresses[index]
                        : "Unknown",
                    isStart: location.includes("Start Location"),
                  });
                }
              }
            });
          } else {
            console.warn("No valid route or coordinates data for waypoints");
          }

          // Add markers for each valid location
          validLocations.forEach((location, index) => {
            try {
              // Create custom marker icon
              let icon;

              if (location.isStart) {
                // Special icon for start location
                icon = L.divIcon({
                  className: "custom-div-icon",
                  html: `<div style="background-color:#38761d; color:white; width:30px; height:30px; border-radius:50%; text-align:center; line-height:30px; font-weight:bold;">S</div>`,
                  iconSize: [30, 30],
                  iconAnchor: [15, 15],
                });
              } else {
                // Numbered icons for other stops
                icon = L.divIcon({
                  className: "custom-div-icon",
                  html: `<div style="background-color:#2c88d9; color:white; width:25px; height:25px; border-radius:50%; text-align:center; line-height:25px; font-weight:bold;">${index}</div>`,
                  iconSize: [25, 25],
                  iconAnchor: [12, 12],
                });
              }

              // Create marker with the icon
              const marker = L.marker(location.coords, { icon }).addTo(
                window.map
              );

              // Store marker reference on the location object for later use
              location.marker = marker;

              // Add popup with location info
              marker.bindPopup(`
                <strong>${location.name}</strong><br>
                Area: ${location.area}<br>
                Address: ${location.address}
              `);

              // Open popup for start location
              if (location.isStart && marker.openPopup) {
                marker.openPopup();
              }
            } catch (error) {
              console.error("Error creating marker:", error);
            }
          });

          // Try to create a route with Leaflet Routing Machine
          if (waypoints.length >= 2) {
            try {
              // Create the route
              const routeControl = L.Routing.control({
                waypoints: waypoints,
                routeWhileDragging: false,
                addWaypoints: false,
                createMarker: function () {
                  return null;
                }, // No markers from routing machine
                lineOptions: {
                  styles: [{ color: "#0000FF", opacity: 0.7, weight: 5 }],
                },
                show: false, // Don't show the routing instructions
              }).addTo(window.map);

              // Store for later use
              window.routeControl = routeControl;

              // Add arrow decorators to the route
              routeControl.on("routesfound", function (e) {
                try {
                  const routes = e.routes;

                  if (routes && routes.length > 0) {
                    // Get the route coordinates
                    const routeCoordinates = routes[0].coordinates;

                    // Create a polyline from the coordinates
                    const polyline = L.polyline(routeCoordinates);

                    // Add arrow decorators
                    const decorator = L.polylineDecorator(polyline, {
                      patterns: [
                        {
                          offset: 25,
                          repeat: 100,
                          symbol: L.Symbol.arrowHead({
                            pixelSize: 15,
                            polygon: false,
                            pathOptions: {
                              stroke: true,
                              color: "#22a",
                              weight: 3,
                            },
                          }),
                        },
                      ],
                    }).addTo(window.map);

                    // Store for cleanup
                    window.routeDecorator = decorator;
                  }
                } catch (error) {
                  console.error("Error adding route decorators:", error);
                }
              });
            } catch (error) {
              console.error("Error creating route:", error);
              // Fallback to simple polyline
              try {
                if (waypoints.length > 0) {
                  L.polyline(waypoints, { color: "blue" }).addTo(window.map);
                }
              } catch (innerError) {
                console.error("Error creating fallback polyline:", innerError);
              }
            }
          } else {
            // Fallback to simple polyline if not enough waypoints
            console.warn(
              "Not enough valid waypoints for routing, need at least 2, got:",
              waypoints.length
            );
            try {
              if (waypoints.length > 0) {
                L.polyline(waypoints, { color: "blue" }).addTo(window.map);
              }
            } catch (error) {
              console.error("Error creating fallback polyline:", error);
            }
          }

          // Fit map bounds to include all waypoints
          if (waypoints.length > 0) {
            try {
              window.map.fitBounds(L.latLngBounds(waypoints).pad(0.2));
            } catch (error) {
              console.error("Error fitting bounds:", error);
              // Fallback to center on first waypoint
              try {
                if (waypoints[0]) {
                  window.map.setView(waypoints[0], 12);
                }
              } catch (innerError) {
                console.error("Error with fallback centering:", innerError);
              }
            }
          }

          // Add event handlers for the reset and return buttons
          $("#resetRouteBtn")
            .off("click")
            .on("click", function () {
              $("#routeResult").hide();
              $(".customer-checkbox").prop("checked", false);
              $("#selectAllCustomers").prop("checked", false);
            });

          $("#returnToStart")
            .off("click")
            .on("click", function () {
              // Fly to the start location
              if (postmanLocation && window.map) {
                try {
                  window.map.flyTo(postmanLocation, 15);

                  // Find and open the start marker popup
                  validLocations.forEach((location) => {
                    if (
                      location.isStart &&
                      location.marker &&
                      typeof location.marker.openPopup === "function"
                    ) {
                      location.marker.openPopup();
                    }
                  });
                } catch (error) {
                  console.error("Error returning to start:", error);
                }
              }
            });
        }

        // Handle chat minimize/maximize
        $("#chatMinimize").click(function () {
          const chatBody = $("#chatBody");
          if (chatBody.is(":visible")) {
            chatBody.hide();
            $(this).html('<i class="bi bi-plus-lg"></i>');
          } else {
            chatBody.show();
            $(this).html('<i class="bi bi-dash-lg"></i>');
          }
        });

        // Handle chat form submission
        $("#chatForm").submit(function (e) {
          e.preventDefault();

          const userMessage = $("#chatInput").val();
          if (!userMessage.trim()) return;

          // Add user message to chat
          $("#chatMessages").append(`
            <div class="alert alert-secondary text-end mb-2">
              <i class="bi bi-person-fill me-2"></i> ${userMessage}
            </div>
          `);

          // Clear input
          $("#chatInput").val("");

          // Scroll to bottom
          $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);

          // Add loading indicator
          const loadingId = Date.now();
          $("#chatMessages").append(`
            <div id="loading-${loadingId}" class="alert alert-light text-center mb-2">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <span class="ms-2">Thinking...</span>
            </div>
          `);

          // Send to backend
          $.ajax({
            url: "/chat",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ message: userMessage }),
            success: function (response) {
              // Remove loading indicator
              $(`#loading-${loadingId}`).remove();

              // Add assistant response
              $("#chatMessages").append(`
                <div class="alert alert-info mb-2">
                  <i class="bi bi-robot me-2"></i> ${response.response}
                </div>
              `);

              // Scroll to bottom
              $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
            },
            error: function (xhr) {
              // Remove loading indicator
              $(`#loading-${loadingId}`).remove();

              // Add error message
              let errorMessage =
                "Sorry, I couldn't process your request. Please try again.";
              if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
              }

              $("#chatMessages").append(`
                <div class="alert alert-danger mb-2">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i> ${errorMessage}
                </div>
              `);

              // Scroll to bottom
              $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
            },
          });
        });

        // Example questions
        const exampleQuestions = [
          "What are today's deliveries?",
          "What's the optimal time to deliver to Aditya?",
          "Explain the current optimized route",
          "Which areas have deliveries today?",
          "Tell me about Kabir's delivery preferences",
        ];

        // Add example question buttons
        const examplesContainer = $(
          '<div class="d-flex flex-wrap mt-2 gap-1"></div>'
        );
        exampleQuestions.forEach((question) => {
          const btn = $(
            `<button class="btn btn-sm btn-outline-secondary example-question">${question}</button>`
          );
          examplesContainer.append(btn);
        });
        $("#chatForm").after(examplesContainer);

        // Handle example question clicks
        $(".example-question").click(function () {
          const question = $(this).text();
          $("#chatInput").val(question);
          $("#chatForm").submit();
        });

        // Handle schedule checkbox changes
        $(".schedule-checkbox").change(function () {
          updateScheduleButtonVisibility();
        });

        // Handle "Schedule All for Today" buttons
        $(".schedule-for-today-btn").click(function (e) {
          e.preventDefault();

          const orderIds = $(this).data("group-orders");
          const customerName = $(this).data("group-name");

          // Confirm scheduling
          if (
            confirm(
              `Schedule all orders for ${customerName} for today (${currentDay})?`
            )
          ) {
            scheduleOrdersForToday(orderIds);
          }
        });

        // Handle "Schedule Selected Orders" button
        $("#scheduleSelectedBtn").click(function (e) {
          e.preventDefault();

          const selectedOrderIds = [];
          $(".schedule-checkbox:checked").each(function () {
            selectedOrderIds.push($(this).val());
          });

          if (selectedOrderIds.length === 0) {
            alert("No orders selected for scheduling.");
            return;
          }

          if (
            confirm(
              `Schedule ${selectedOrderIds.length} selected orders for today?`
            )
          ) {
            scheduleOrdersForToday(selectedOrderIds);
          }
        });

        // Function to update schedule button visibility
        function updateScheduleButtonVisibility() {
          const checkedCount = $(".schedule-checkbox:checked").length;
          if (checkedCount > 0) {
            $("#scheduleSelectedBtn")
              .show()
              .text(`Schedule ${checkedCount} Selected Orders`);
          } else {
            $("#scheduleSelectedBtn").hide();
          }
        }

        // Function to schedule orders for today
        function scheduleOrdersForToday(orderIds) {
          // Validate order IDs
          if (!orderIds || (Array.isArray(orderIds) && orderIds.length === 0)) {
            alert("No orders selected for scheduling.");
            return;
          }

          // Show loading indicator
          $("#routeLoadingIndicator").show();

          // Prepare the data
          const formData = new FormData();

          // Add each order ID
          try {
            if (Array.isArray(orderIds)) {
              orderIds.forEach((id) => {
                if (id) formData.append("selected_orders[]", id);
              });
            } else {
              formData.append("selected_orders[]", orderIds);
            }
          } catch (error) {
            console.error("Error preparing form data:", error);
            $("#routeLoadingIndicator").hide();
            alert("Error preparing order data. Please try again.");
            return;
          }

          // Send the AJAX request
          $.ajax({
            url: "/schedule_for_today",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
              $("#routeLoadingIndicator").hide();

              if (response && response.success) {
                // Show success message
                alert(response.message || "Orders scheduled successfully");

                // Scroll to the route optimization section
                try {
                  $("html, body").animate(
                    {
                      scrollTop: $("#routeOptimizationForm").offset().top - 50,
                    },
                    500
                  );
                } catch (error) {
                  console.error(
                    "Error scrolling to route optimization form:",
                    error
                  );
                }

                // Validate optimized route before storing
                if (
                  response.optimized_route &&
                  typeof response.optimized_route === "object" &&
                  response.optimized_route.route &&
                  Array.isArray(response.optimized_route.route) &&
                  response.optimized_route.route.length > 0
                ) {
                  // Store route data for persistence across page reloads
                  try {
                    localStorage.setItem(
                      "scheduledRoute",
                      JSON.stringify(response.optimized_route)
                    );
                    localStorage.setItem("scheduleSuccess", "true");
                  } catch (storageError) {
                    console.error(
                      "Error storing route in localStorage:",
                      storageError
                    );
                  }

                  // Update the route optimization view with the new route
                  try {
                    displayOptimizedRoute(response.optimized_route);
                  } catch (displayError) {
                    console.error(
                      "Error displaying optimized route:",
                      displayError
                    );
                  }
                } else {
                  console.error(
                    "Invalid optimized route in response:",
                    response.optimized_route
                  );
                }

                // Uncheck all schedule checkboxes
                $(".schedule-checkbox").prop("checked", false);
                updateScheduleButtonVisibility();

                // Reload the page to reflect the updated orders
                setTimeout(function () {
                  location.reload();
                }, 2000);
              } else {
                let errorMsg =
                  "Unknown error occurred while scheduling orders.";
                if (response && response.message) {
                  errorMsg = response.message;
                }
                alert("Error: " + errorMsg);
              }
            },
            error: function (xhr) {
              $("#routeLoadingIndicator").hide();

              let errorMessage = "An error occurred while scheduling orders.";
              try {
                if (xhr && xhr.responseJSON && xhr.responseJSON.message) {
                  errorMessage = xhr.responseJSON.message;
                }
              } catch (error) {
                console.error("Error parsing error response:", error);
              }

              alert("Error: " + errorMessage);
            },
          });
        }
      });
    </script>
  </body>
</html>
