<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delivery Prediction System</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸšš</text></svg>"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        padding-top: 20px;
      }
      .prediction-result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        background-color: #f8f9fa;
      }
      .time-badge {
        font-size: 1.1em;
        margin: 0 5px;
        padding: 5px 10px;
      }
      .failure-rate {
        font-size: 0.9em;
        display: block;
        margin-top: 5px;
      }
      .order-card {
        margin-bottom: 15px;
      }
      .route-segment {
        padding: 10px;
        margin-bottom: 10px;
        border-left: 3px solid #0d6efd;
        background-color: #f8f9fa;
      }
      .route-map {
        height: 400px;
        width: 100%;
        border-radius: 5px;
        margin-top: 15px;
      }
      .customer-address {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 3px;
      }
      .checkout-container {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
      }
      /* Leaflet custom styles */
      #map {
        height: 400px;
        width: 100%;
        border-radius: 5px;
      }
      .custom-div-icon div {
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .leaflet-popup-content {
        margin: 10px;
      }
      .leaflet-popup-content-wrapper {
        border-radius: 5px;
      }
      .route-summary {
        font-size: 14px;
      }
      /* Hide Leaflet Routing Machine control panel but keep the route */
      .leaflet-routing-container {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4">Delivery Prediction System</h1>

      <div class="row">
        <!-- Left Column -->
        <div class="col-md-6">
          <!-- Prediction Section -->
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h4>Predict Optimal Delivery Times</h4>
            </div>
            <div class="card-body">
              <form id="predictionForm">
                <div class="mb-3">
                  <label for="name" class="form-label">Customer Name:</label>
                  <select class="form-select" id="name" name="name" required>
                    <option value="" selected disabled>
                      Select a customer
                    </option>
                    {% for name in names %}
                    <option value="{{ name }}">{{ name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="day" class="form-label">Day of Delivery:</label>
                  <select class="form-select" id="day" name="day">
                    <option value="{{ current_day }}" selected>
                      Today ({{ current_day }})
                    </option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                  </select>
                </div>

                <button type="submit" class="btn btn-primary">
                  Predict Optimal Times
                </button>
              </form>

              <div
                id="predictionResult"
                class="prediction-result"
                style="display: none"
              >
                <h5>
                  Optimal Delivery Times for <span id="customerName"></span> on
                  <span id="deliveryDay"></span>:
                </h5>
                <div id="optimalTimes" class="mt-3"></div>
              </div>
            </div>
          </div>

          <!-- Add New Order -->
          <div class="card mt-4">
            <div class="card-header bg-success text-white">
              <h4>Add New Order</h4>
            </div>
            <div class="card-body">
              <form id="newOrderForm">
                <div class="mb-3">
                  <label for="order_name" class="form-label"
                    >Customer Name:</label
                  >
                  <select
                    class="form-select"
                    id="order_name"
                    name="name"
                    required
                    onchange="updateAreaInfo()"
                  >
                    <option value="" selected disabled>
                      Select a customer
                    </option>
                    <option value="Aditya">Aditya (Satellite)</option>
                    <option value="Vivaan">Vivaan (Bopal)</option>
                    <option value="Aarav">Aarav (Vastrapur)</option>
                    <option value="Meera">Meera (Paldi)</option>
                    <option value="Diya">Diya (Thaltej)</option>
                    <option value="Riya">Riya (Navrangpura)</option>
                    <option value="Ananya">Ananya (Bodakdev)</option>
                    <option value="Aryan">Aryan (Gota)</option>
                    <option value="Ishaan">Ishaan (Maninagar)</option>
                    <option value="Kabir">Kabir (Chandkheda)</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="delivery_day" class="form-label"
                    >Day of Delivery:</label
                  >
                  <select
                    class="form-select"
                    id="delivery_day"
                    name="delivery_day"
                    required
                  >
                    <option value="{{ current_day }}">
                      Today ({{ current_day }})
                    </option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="customer_area" class="form-label">Area:</label>
                  <input
                    type="text"
                    class="form-control"
                    id="customer_area"
                    readonly
                    disabled
                  />
                  <small class="text-muted"
                    >Area is automatically assigned based on the customer</small
                  >
                </div>

                <div class="mb-3">
                  <label for="package_size" class="form-label"
                    >Package Size:</label
                  >
                  <select
                    class="form-select"
                    id="package_size"
                    name="package_size"
                    required
                  >
                    <option value="Small">Small</option>
                    <option value="Medium">Medium</option>
                    <option value="Large">Large</option>
                  </select>
                </div>

                <button type="submit" class="btn btn-success">Add Order</button>
              </form>

              <div
                id="orderResult"
                class="alert alert-success mt-3"
                style="display: none"
              >
                Order added successfully!
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-6">
          <!-- Route Optimization Section -->
          <div class="card mb-4">
            <div class="card-header bg-info text-white">
              <h4>Route Optimization</h4>
            </div>
            <div class="card-body">
              <p>Plan the most efficient delivery route for today's orders.</p>

              <form id="routeOptimizationForm">
                <div class="mb-3">
                  <label class="form-label"
                    >Select Customers for Today's Delivery Route:</label
                  >
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="selectAllCustomers"
                    />
                    <label class="form-check-label" for="selectAllCustomers">
                      Select All Today's Orders
                    </label>
                  </div>

                  <div id="todaysOrdersList" class="mt-2">
                    {% for order in grouped_todays_orders %}
                    <div class="form-check">
                      <input
                        class="form-check-input customer-checkbox"
                        type="checkbox"
                        name="selected_customers[]"
                        value="{{ order.name }}"
                        id="customer-{{ order.order_id }}"
                        data-count="{{ order.parcel_count }}"
                      />
                      <label
                        class="form-check-label"
                        for="customer-{{ order.order_id }}"
                      >
                        {{ order.name }} ({{ order.area }}) {% if
                        order.parcel_count > 1 %}
                        <span class="badge bg-primary"
                          >{{ order.parcel_count }} parcels</span
                        >
                        {% endif %}
                        <div class="customer-address">{{ order.address }}</div>
                      </label>
                    </div>
                    {% endfor %}
                  </div>
                </div>

                <button type="submit" class="btn btn-info">
                  Optimize Route
                </button>
              </form>

              <div
                id="routeLoadingIndicator"
                class="text-center my-4"
                style="display: none"
              >
                <div class="spinner-border text-info" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Calculating optimal delivery route...</p>
              </div>

              <div id="routeResult" class="mt-4" style="display: none">
                <h5>Optimal Delivery Route:</h5>
                <div class="alert alert-info">
                  <span id="routeSummary"></span>
                  <div id="totalDistance" class="mt-2"></div>
                </div>

                <div id="routeDetails"></div>

                <div id="routeMap" class="route-map"></div>

                <div class="mt-3 text-end">
                  <button id="resetRouteBtn" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-counterclockwise"></i> Plan New Route
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Pending Orders -->
          <div class="card">
            <div class="card-header bg-warning">
              <h4>Pending Orders ({{ pending_orders|length }})</h4>
            </div>
            <div class="card-body">
              <div class="list-group" id="ordersContainer">
                {% for group in grouped_pending_orders %}
                <div class="card order-card">
                  <div class="card-body">
                    <h5 class="card-title">
                      {{ group.name }} {% if group.orders|length > 1 %}
                      <span class="badge bg-primary"
                        >{{ group.orders|length }} parcels</span
                      >
                      {% endif %}
                    </h5>
                    <p class="card-text">
                      <strong>Delivery Day:</strong> {{ group.delivery_day }}<br />
                      <strong>Area:</strong> {{ group.area }}<br />
                      <strong>Address:</strong> {{ group.address }}<br />
                    </p>
                    <div class="mt-3">
                      <strong>Parcels:</strong>
                      <ul class="list-group mt-2">
                        {% for order in group.orders %}
                        <li
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>#{{ order.order_id }}</strong> - {{
                            order.package_size }} package
                            <span class="badge bg-warning ms-2"
                              >{{ order.status }}</span
                            >
                          </div>
                          <div class="btn-group" role="group">
                            <a
                              href="/mark_delivered/{{ order.order_id }}?success=true"
                              class="btn btn-success btn-sm"
                              >Delivered</a
                            >
                            <a
                              href="/mark_delivered/{{ order.order_id }}?success=false"
                              class="btn btn-danger btn-sm"
                              >Failed</a
                            >
                          </div>
                        </li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script>
      // Function to geocode address using Nominatim
      function geocodeAddress(address) {
        return new Promise((resolve, reject) => {
          const encodedAddress = encodeURIComponent(address);
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1`;

          fetch(url, {
            headers: {
              Accept: "application/json",
              "User-Agent": "DeliveryPredictionSystem/1.0",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data && data.length > 0) {
                const result = data[0];
                resolve([parseFloat(result.lat), parseFloat(result.lon)]);
              } else {
                reject(new Error("Address not found"));
              }
            })
            .catch((error) => {
              console.error("Geocoding error:", error);
              reject(error);
            });
        });
      }

      // Customer area mapping
      const customerAreas = {
        Aditya: "Satellite",
        Vivaan: "Bopal",
        Aarav: "Vastrapur",
        Meera: "Paldi",
        Diya: "Thaltej",
        Riya: "Navrangpura",
        Ananya: "Bodakdev",
        Aryan: "Gota",
        Ishaan: "Maninagar",
        Kabir: "Chandkheda",
      };

      function updateAreaInfo() {
        const customerName = document.getElementById("order_name").value;
        const areaField = document.getElementById("customer_area");

        if (customerName && customerAreas[customerName]) {
          areaField.value = customerAreas[customerName];
        } else {
          areaField.value = "";
        }
      }

      $(document).ready(function () {
        // Initialize area display
        updateAreaInfo();

        // Reset route planning
        $(document).on("click", "#resetRouteBtn", function () {
          // Clear checkboxes
          $(".customer-checkbox").prop("checked", false);
          $("#selectAllCustomers").prop("checked", false);

          // Hide route result
          $("#routeResult").hide();

          // Scroll back to the form
          $("html, body").animate(
            {
              scrollTop: $("#routeOptimizationForm").offset().top - 20,
            },
            500
          );
        });

        // Prediction form submission
        $("#predictionForm").submit(function (e) {
          e.preventDefault();

          $.ajax({
            url: "/predict",
            type: "POST",
            data: $(this).serialize(),
            success: function (response) {
              $("#customerName").text(response.name);
              $("#deliveryDay").text(response.day);

              let timesHtml = "";
              response.optimal_times.forEach(function (prediction) {
                if (typeof prediction === "object") {
                  timesHtml += `
                    <div class="mb-2">
                      <span class="badge bg-primary time-badge">${prediction.time}</span>
                      <span class="badge bg-danger failure-rate">${prediction.failure_rate}% Failure Rate</span>
                    </div>
                  `;
                } else {
                  timesHtml += `<span class="badge bg-primary time-badge">${prediction}</span>`;
                }
              });

              $("#optimalTimes").html(timesHtml);
              $("#predictionResult").show();
            },
          });
        });

        // New order form submission
        $("#newOrderForm").submit(function (e) {
          e.preventDefault();

          $.ajax({
            url: "/add_order",
            type: "POST",
            data: $(this).serialize(),
            success: function (response) {
              $("#orderResult").show().delay(3000).fadeOut();
              setTimeout(function () {
                location.reload();
              }, 3000);
            },
          });
        });

        // Select/deselect all customers
        $("#selectAllCustomers").change(function () {
          $(".customer-checkbox").prop("checked", $(this).prop("checked"));
        });

        // Route optimization form submission
        $("#routeOptimizationForm").submit(function (e) {
          e.preventDefault();

          // Get selected customers with counts
          const selectedCustomers = [];
          $(".customer-checkbox:checked").each(function () {
            const customerName = $(this).val();
            const count = parseInt($(this).data("count") || 1);

            // Add the customer to the list based on the parcel count
            for (let i = 0; i < count; i++) {
              selectedCustomers.push(customerName);
            }
          });

          // Show loading indicator
          $("#routeLoadingIndicator").show();
          $("#routeResult").hide();

          // Build the form data
          const formData = new FormData();
          selectedCustomers.forEach((name) => {
            formData.append("selected_customers[]", name);
          });

          $.ajax({
            url: "/optimize_route",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
              // Hide loading indicator
              $("#routeLoadingIndicator").hide();

              // Display route summary
              $("#routeSummary").html(
                `Optimal delivery order: <strong>${response.route.join(
                  " â†’ "
                )}</strong>`
              );
              $("#totalDistance").html(
                `Total distance: <strong>${response.total_distance}</strong>`
              );

              // Display detailed route
              let routeDetailsHtml = "";
              response.details.forEach(function (leg, index) {
                routeDetailsHtml += `
                  <div class="route-segment">
                    <div class="fw-bold">Leg ${index + 1}: ${leg.from} â†’ ${
                  leg.to
                }</div>
                    <div class="mt-1">
                      <span class="badge bg-secondary me-2">Distance: ${
                        leg.distance
                      }</span>
                      <span class="badge bg-secondary">Duration: ${
                        leg.duration
                      }</span>
                    </div>
                    <div class="customer-address mt-2">
                      <div><small>From: ${leg.from_address}</small></div>
                      <div><small>To: ${leg.to_address}</small></div>
                    </div>
                  </div>
                `;
              });

              $("#routeDetails").html(routeDetailsHtml);

              // Initialize route map using Leaflet
              initRouteMap(response);

              // Show the result
              $("#routeResult").show();
            },
            error: function (error) {
              // Hide loading indicator and show error
              $("#routeLoadingIndicator").hide();
              alert(
                "An error occurred while optimizing the route. Please try again."
              );
              console.error("Route optimization error:", error);
            },
          });
        });

        // Function to initialize the route map using Leaflet
        function initRouteMap(routeData) {
          // Clear any existing map
          $("#routeMap").empty();
          $("#routeMap").html('<div id="map" style="height: 400px;"></div>');

          // Define coordinates for Ahmedabad areas (accurate)
          const areaCoordinates = {
            Satellite: [23.030357, 72.517845],
            Bopal: [23.032011, 72.467816],
            Vastrapur: [23.0362554310379, 72.5305526298169],
            Paldi: [23.013054, 72.562515],
            Thaltej: [23.049736, 72.511726],
            Navrangpura: [23.036406, 72.561066],
            Bodakdev: [23.0394524, 72.512492],
            Gota: [23.104, 72.5399],
            Maninagar: [22.99617, 72.599586],
            Chandkheda: [23.11842, 72.586777],
            "Start Location (Postman)": [23.0269, 72.5297], // Iscon Center, Shivranjani Cross Road coordinates
          };

          // Define customer address coordinates for Leaflet geocoding
          const customerAddresses = {
            Aditya: {
              address:
                "Near Jodhpur Cross Road, Satellite, Ahmedabad, Gujarat, India",
              area: "Satellite",
              coords: [23.030357, 72.517845],
              geocodeAddress: "Satellite, Ahmedabad, Gujarat, India",
            },
            Vivaan: {
              address: "Near Bopal Cross Road, Bopal, Ahmedabad - 380058",
              area: "Bopal",
              coords: [23.032011, 72.467816],
              geocodeAddress: "Bopal, Ahmedabad, Gujarat, India",
            },
            Aarav: {
              address: "Near Vastrapur Lake, Vastrapur, Ahmedabad - 380015",
              area: "Vastrapur",
              coords: [23.0362554310379, 72.5305526298169],
              geocodeAddress: "Vastrapur, Ahmedabad, Gujarat, India",
            },
            Meera: {
              address: "Opposite Dharnidhar Derasar, Paldi, Ahmedabad - 380007",
              area: "Paldi",
              coords: [23.013054, 72.562515],
              geocodeAddress: "Paldi, Ahmedabad, Gujarat, India",
            },
            Diya: {
              address:
                "Near Thaltej Cross Road, S.G. Highway, Ahmedabad - 380054",
              area: "Thaltej",
              coords: [23.049736, 72.511726],
              geocodeAddress: "Thaltej, Ahmedabad, Gujarat, India",
            },
            Riya: {
              address:
                "Near Navrangpura AMTS Bus Stop, Navrangpura, Ahmedabad - 380009",
              area: "Navrangpura",
              coords: [23.036406, 72.561066],
              geocodeAddress: "Navrangpura, Ahmedabad, Gujarat, India",
            },
            Ananya: {
              address: "Opposite Rajpath Club, Bodakdev, Ahmedabad - 380054",
              area: "Bodakdev",
              coords: [23.0394524, 72.512492],
              geocodeAddress: "Bodakdev, Ahmedabad, Gujarat, India",
            },
            Aryan: {
              address: "Near Oganaj Gam, Gota, Ahmedabad - 382481",
              area: "Gota",
              coords: [23.104, 72.5399],
              geocodeAddress: "Gota, Ahmedabad, Gujarat, India",
            },
            Ishaan: {
              address:
                "Opposite Rambaug Police Station, Maninagar, Ahmedabad - 380008",
              area: "Maninagar",
              coords: [22.99617, 72.599586],
              geocodeAddress: "Maninagar, Ahmedabad, Gujarat, India",
            },
            Kabir: {
              address:
                "Near Chandkheda Gam Bus Stop, Chandkheda, Ahmedabad - 382424",
              area: "Chandkheda",
              coords: [23.11842, 72.586777],
              geocodeAddress: "Chandkheda, Ahmedabad, Gujarat, India",
            },
            "Start Location (Postman)": {
              address:
                "Iscon Center, Shivranjani Cross Road, Satellite, Ahmedabad, India",
              area: "Satellite",
              coords: [23.0269, 72.5297],
              geocodeAddress:
                "Iscon Center, Shivranjani Cross Road, Satellite, Ahmedabad, India",
            },
          };

          // Initialize map centered on postman's location (Satellite)
          const defaultCenter = [23.0225, 72.5714]; // Ahmedabad center as fallback
          let postmanLocation;

          try {
            // Get postman location with validation
            const rawLocation = areaCoordinates["Start Location (Postman)"];
            if (
              rawLocation &&
              Array.isArray(rawLocation) &&
              rawLocation.length === 2 &&
              !isNaN(parseFloat(rawLocation[0])) &&
              !isNaN(parseFloat(rawLocation[1]))
            ) {
              // Parse as floats for stability
              postmanLocation = [
                parseFloat(rawLocation[0]),
                parseFloat(rawLocation[1]),
              ];
            } else {
              console.warn(
                "Invalid postman location in data, using default:",
                rawLocation
              );
              postmanLocation = defaultCenter;
            }
          } catch (error) {
            console.error("Error setting postman location:", error);
            postmanLocation = defaultCenter;
          }

          // Create the map with validated location
          const map = L.map("map").setView(postmanLocation, 15);

          // Set max bounds to Ahmedabad region to prevent excessive panning
          const southWest = L.latLng(22.9, 72.4);
          const northEast = L.latLng(23.2, 72.7);
          map.setMaxBounds(L.latLngBounds(southWest, northEast));

          // Add OpenStreetMap tile layer
          L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "Â© OpenStreetMap",
          }).addTo(map);

          // Create start icon for postman location
          const startIcon = L.divIcon({
            className: "custom-div-icon",
            html: `<div style="background-color: #198754; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 3px solid white; font-size: 16px;">S</div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 18],
          });

          // Store markers and selected locations
          const markers = {};
          const selectedLocations = {};
          let waypoints = [];

          // Add start location marker (with validation)
          let startMarker;
          try {
            const startLocation = L.latLng(
              postmanLocation[0],
              postmanLocation[1]
            );
            startMarker = L.marker(startLocation, { icon: startIcon })
              .addTo(map)
              .bindPopup(
                '<div style="text-align: center;"><b>Start Location (Postman)</b></div><hr style="margin: 5px 0;"><div>Iscon Center, Shivranjani Cross Road</div><div style="font-size: 0.9em; margin-top: 5px; color: #198754;">All routes start here</div>'
              );

            // Open postman popup by default
            startMarker.openPopup();

            // Add a circle around the starting location
            L.circle(startLocation, {
              color: "#198754",
              fillColor: "#198754",
              fillOpacity: 0.15,
              radius: 200,
              weight: 2,
            }).addTo(map);

            // Add start location to waypoints (with validation)
            waypoints.push(startLocation);
          } catch (error) {
            console.error("Error creating start marker:", error);
            // Create fallback marker at Ahmedabad center
            const fallbackLocation = L.latLng(23.0225, 72.5714);
            startMarker = L.marker(fallbackLocation, { icon: startIcon })
              .addTo(map)
              .bindPopup(
                '<div style="text-align: center;"><b>Start Location (Postman)</b></div><hr style="margin: 5px 0;"><div>Iscon Center, Shivranjani Cross Road</div><div style="font-size: 0.9em; margin-top: 5px; color: #198754;">Fallback location</div>'
              );

            // Add fallback circle
            L.circle(fallbackLocation, {
              color: "#198754",
              fillColor: "#198754",
              fillOpacity: 0.15,
              radius: 200,
              weight: 2,
            }).addTo(map);

            // Add fallback location to waypoints
            waypoints.push(fallbackLocation);
          }

          // Process route data
          if (routeData && routeData.details && routeData.details.length > 0) {
            console.log(
              "Processing route data with details:",
              routeData.details.length
            );

            // Process each delivery location from route data
            routeData.details.forEach((leg, index) => {
              const toName = leg.to;
              // Extract customer name without parcel count
              let customerName = toName.split(" (")[0].trim();

              console.log(
                `Processing delivery point ${index + 1}: ${customerName}`
              );

              // Find the coordinates from customerAddresses if available
              let coords = null;

              try {
                if (customerName in customerAddresses) {
                  console.log(`Found ${customerName} in customerAddresses`);
                  coords = customerAddresses[customerName].coords;
                  console.log(`Coordinates for ${customerName}: [${coords}]`);
                } else {
                  console.log(
                    `${customerName} not found in customerAddresses, trying area coordinates`
                  );
                  // Find the exact case for the customer name in the coordinates object
                  const exactCustomerName =
                    Object.keys(areaCoordinates).find(
                      (key) => key.toLowerCase() === customerName.toLowerCase()
                    ) || customerName;

                  // Get coordinates for this customer
                  coords = areaCoordinates[exactCustomerName];
                  console.log(
                    `Area coordinates for ${exactCustomerName}: [${coords}]`
                  );
                }

                // Simple validation of coordinates
                if (coords && Array.isArray(coords) && coords.length === 2) {
                  console.log(
                    `Valid coordinates found for ${customerName}: [${coords}]`
                  );

                  // Create numbered icon for this delivery point
                  const deliveryIcon = L.divIcon({
                    className: "custom-div-icon",
                    html: `<div style="background-color: #0d6efd; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white;">${
                      index + 1
                    }</div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14],
                  });

                  // Create marker and add to map
                  const validCoords = [
                    parseFloat(coords[0]),
                    parseFloat(coords[1]),
                  ];
                  console.log(
                    `Creating marker for ${customerName} at [${validCoords}]`
                  );

                  // Add popup content
                  let popupContent = `<div style="text-align: center;"><b>${toName}</b></div>`;
                  popupContent += `<hr style="margin: 5px 0;">`;
                  popupContent += `<b>Address:</b> ${
                    leg.to_address || "Not available"
                  }<br>`;
                  popupContent += `<b>Distance:</b> ${
                    leg.distance || "Not available"
                  }<br>`;
                  popupContent += `<b>Duration:</b> ${
                    leg.duration || "Not available"
                  }`;

                  // Add marker to map
                  const marker = L.marker(validCoords, { icon: deliveryIcon })
                    .addTo(map)
                    .bindPopup(popupContent);

                  console.log(`Added marker for ${customerName}`);

                  // Add to waypoints for routing
                  const latLng = L.latLng(validCoords[0], validCoords[1]);
                  waypoints.push(latLng);
                  console.log(
                    `Added ${customerName} to waypoints: ${waypoints.length} total`
                  );
                } else {
                  console.error(
                    `Invalid coordinates for ${customerName}: [${coords}]`
                  );
                }
              } catch (error) {
                console.error(`Error processing ${customerName}:`, error);
              }
            });

            console.log(`Total waypoints: ${waypoints.length}`);

            // If we have valid waypoints, create the route
            if (waypoints.length >= 2) {
              console.log("Creating route with waypoints:", waypoints);
              // Create a simple polyline to connect all points
              const polyline = L.polyline(waypoints, {
                color: "#0d6efd",
                weight: 4,
              }).addTo(map);

              // Fit the map to show all waypoints
              try {
                const bounds = L.latLngBounds(waypoints);
                map.fitBounds(bounds.pad(0.1));
                console.log("Map bounds set to show all waypoints");
              } catch (error) {
                console.error("Error setting map bounds:", error);
                // Fall back to center on postman location
                map.setView(postmanLocation, 13);
              }

              // Try to add the Routing Machine route if available
              try {
                if (typeof L.Routing !== "undefined") {
                  console.log("Creating Routing Machine route");
                  const routingControl = L.Routing.control({
                    waypoints: waypoints,
                    routeWhileDragging: false,
                    showAlternatives: false,
                    fitSelectedRoutes: false,
                    show: false,
                    lineOptions: {
                      styles: [
                        { color: "black", opacity: 0.15, weight: 7 },
                        { color: "#0d6efd", opacity: 0.8, weight: 5 },
                      ],
                    },
                    createMarker: function () {
                      return null; // Don't create default markers
                    },
                  }).addTo(map);

                  console.log("Routing control added to map");

                  // Hide the routing control container
                  setTimeout(() => {
                    const container = document.querySelector(
                      ".leaflet-routing-container"
                    );
                    if (container) {
                      container.style.display = "none";
                    }
                  }, 100);
                }
              } catch (error) {
                console.error("Error creating Routing Machine route:", error);
              }

              // Add directional arrows using Polyline Decorator if available
              try {
                if (typeof L.polylineDecorator !== "undefined") {
                  console.log(
                    "Adding directional arrows with Polyline Decorator"
                  );
                  const arrowDecorator = L.polylineDecorator(waypoints, {
                    patterns: [
                      {
                        offset: "10%",
                        repeat: "25%",
                        symbol: L.Symbol.arrowHead({
                          pixelSize: 12,
                          headAngle: 45,
                          polygon: true,
                          pathOptions: {
                            color: "#0d6efd",
                            fillColor: "#0d6efd",
                            fillOpacity: 1,
                            weight: 0,
                          },
                        }),
                      },
                    ],
                  }).addTo(map);
                }
              } catch (error) {
                console.error("Error adding directional arrows:", error);
              }

              // Create a control to show route summary
              const summaryControl = L.control({ position: "bottomright" });
              summaryControl.onAdd = function () {
                const div = L.DomUtil.create("div", "route-summary");
                div.innerHTML = `
                  <div style="background-color: white; padding: 8px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.4); max-width: 250px;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: #0d6efd;">Delivery Route Summary</div>
                    <div><b>Total Distance:</b> ${
                      routeData.total_distance
                    }</div>
                    <div><b>Delivery Stops:</b> ${waypoints.length - 1}</div>
                    <div style="font-size: 0.9em; margin-top: 5px; color: #666;">Numbers show delivery order</div>
                  </div>
                `;
                return div;
              };
              summaryControl.addTo(map);

              // Add a control button to go back to start location
              const backToStartControl = L.control({ position: "topleft" });
              backToStartControl.onAdd = function () {
                const div = L.DomUtil.create("div", "back-to-start-control");
                div.innerHTML = `
                  <button id="back-to-start-btn" class="btn btn-success" 
                    style="padding: 6px 12px; font-size: 14px; margin: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                    <i class="bi bi-geo-alt-fill"></i> Go to Starting Point
                  </button>
                `;
                return div;
              };
              backToStartControl.addTo(map);

              // Function to return to starting point (defined within initRouteMap for proper scope)
              function returnToStart() {
                try {
                  if (startMarker && startMarker._latlng) {
                    map.flyTo(startMarker._latlng, 15);
                    if (startMarker.openPopup) {
                      startMarker.openPopup();
                    }
                  } else {
                    console.warn(
                      "Start marker not properly initialized, flying to default center"
                    );
                    map.flyTo([23.0225, 72.5714], 15);
                  }
                } catch (error) {
                  console.error("Error in returnToStart function:", error);
                  // Fallback to Ahmedabad center
                  map.flyTo([23.0225, 72.5714], 15);
                }
              }

              // Add event listener for the back to start button
              setTimeout(() => {
                const backToStartBtn =
                  document.getElementById("back-to-start-btn");
                if (backToStartBtn) {
                  backToStartBtn.addEventListener("click", function () {
                    returnToStart();
                  });
                }
              }, 100);
            }
          }
        }
      });
    </script>
  </body>
</html>
