<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delivery Prediction System</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸšš</text></svg>"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        padding-top: 20px;
      }
      .prediction-result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        background-color: #f8f9fa;
      }
      .time-badge {
        font-size: 1.1em;
        margin: 0 5px;
        padding: 5px 10px;
      }
      .failure-rate {
        font-size: 0.9em;
        display: block;
        margin-top: 5px;
      }
      .order-card {
        margin-bottom: 15px;
      }
      .route-segment {
        padding: 10px;
        margin-bottom: 10px;
        border-left: 3px solid #0d6efd;
        background-color: #f8f9fa;
      }
      .route-map {
        height: 400px;
        width: 100%;
        border-radius: 5px;
        margin-top: 15px;
      }
      .customer-address {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 3px;
      }
      .checkout-container {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
      }
      /* Leaflet custom styles */
      #map {
        height: 400px;
        width: 100%;
        border-radius: 5px;
      }
      .custom-div-icon div {
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .leaflet-popup-content {
        margin: 10px;
      }
      .leaflet-popup-content-wrapper {
        border-radius: 5px;
      }
      .route-summary {
        font-size: 14px;
      }
      /* Hide Leaflet Routing Machine control panel but keep the route */
      .leaflet-routing-container {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4">Delivery Prediction System</h1>

      <!-- Real-time Conditions Dashboard -->
      <div class="card mb-4">
        <div
          class="card-header bg-dark text-white d-flex justify-content-between"
        >
          <h4><i class="bi bi-clock-history me-2"></i>Real-time Conditions</h4>
          <button id="refreshRealTimeData" class="btn btn-sm btn-outline-light">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- Weather Information -->
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-header bg-info text-white">
                  <h5><i class="bi bi-cloud me-2"></i>Weather</h5>
                </div>
                <div class="card-body">
                  <div id="weatherData">
                    <p class="mb-1">{{ real_time_summary.weather }}</p>
                    {% if real_time_data.weather %}
                    <div class="d-flex align-items-center mt-2">
                      <div class="me-3">
                        {% if real_time_data.weather.temperature and
                        real_time_data.weather.temperature.current is defined %}
                        <h3>
                          {{ real_time_data.weather.temperature.current }}Â°{{
                          real_time_data.weather.temperature.units|default('C')
                          }}
                        </h3>
                        {% else %}
                        <h3>
                          {{ real_time_data.weather.get('temperature',
                          {}).get('current', 'N/A') }}Â°{{
                          real_time_data.weather.get('temperature',
                          {}).get('units', 'C') }}
                        </h3>
                        {% endif %}
                      </div>
                      <div>
                        <p class="mb-0">
                          <strong>
                            {{
                            real_time_data.weather.conditions|default('Unknown')
                            }}
                          </strong>
                        </p>
                        <p class="mb-0 small">
                          <i class="bi bi-droplet-half text-primary"></i>
                          Humidity: {{
                          real_time_data.weather.humidity|default('N/A') }}%
                        </p>
                        {% if real_time_data.weather.precipitation and
                        real_time_data.weather.precipitation.chance is defined
                        and real_time_data.weather.precipitation.chance > 0 %}
                        <p class="mb-0 small">
                          <i class="bi bi-cloud-rain text-primary"></i> {{
                          real_time_data.weather.precipitation.chance }}% chance
                          of {{ real_time_data.weather.precipitation.type }}
                        </p>
                        {% elif real_time_data.weather.get('precipitation',
                        {}).get('chance', 0) > 0 %}
                        <p class="mb-0 small">
                          <i class="bi bi-cloud-rain text-primary"></i> {{
                          real_time_data.weather.get('precipitation',
                          {}).get('chance', 0) }}% chance of {{
                          real_time_data.weather.get('precipitation',
                          {}).get('type', 'precipitation') }}
                        </p>
                        {% endif %}
                      </div>
                    </div>
                    {% if real_time_data.weather.warnings and
                    real_time_data.weather.warnings|length > 0 %}
                    <div class="alert alert-warning mt-2 mb-0 py-2">
                      <p class="mb-0">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i
                        ><strong>Warning:</strong> {{
                        real_time_data.weather.warnings[0] }}
                      </p>
                      {% if real_time_data.weather.warnings|length > 1 %} {% set
                      additional_warnings =
                      real_time_data.weather.warnings|length - 1 %} {% if
                      additional_warnings == 1 %}
                      <p class="mb-0 small mt-1">
                        <i class="bi bi-info-circle me-1"></i> {{
                        real_time_data.weather.warnings[1] }}
                      </p>
                      {% else %}
                      <p class="mb-0 small mt-1">
                        <i class="bi bi-info-circle me-1"></i> {{
                        additional_warnings }} more warning{% if
                        additional_warnings > 1 %}s{% endif %}
                      </p>
                      {% endif %} {% endif %}
                    </div>
                    {% endif %} {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Traffic Information -->
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-header bg-danger text-white">
                  <h5>
                    <i class="bi bi-sign-intersection-fill me-2"></i>Traffic
                  </h5>
                </div>
                <div class="card-body">
                  <div id="trafficData">
                    <p class="mb-2">{{ real_time_summary.traffic }}</p>
                    {% if real_time_data.traffic %}
                    <div class="mt-3">
                      <p class="mb-1">
                        <strong>Congestion by Area:</strong>
                        <small class="text-muted"
                          >(Scale: 1-10, where 10 is severe)</small
                        >
                      </p>
                      <div class="row">
                        {% set area_count = 0 %} {% for area, data in
                        real_time_data.traffic.items() %} {% if data is mapping
                        and area_count < 6 %}
                        <!-- Show only top 6 areas -->
                        {% set area_count = area_count + 1 %}
                        <div class="col-6 mb-2">
                          <div class="d-flex align-items-center">
                            <div class="me-2">
                              {% set congestion =
                              data.congestion_level|default(5) %} {% if
                              congestion <= 3 %}
                              <span class="badge bg-success"
                                >{{ congestion }}/10</span
                              >
                              {% elif congestion <= 6 %}
                              <span class="badge bg-warning"
                                >{{ congestion }}/10</span
                              >
                              {% else %}
                              <span class="badge bg-danger"
                                >{{ congestion }}/10</span
                              >
                              {% endif %}
                            </div>
                            <div class="small">{{ area }}</div>
                          </div>
                        </div>
                        {% endif %} {% endfor %}
                      </div>
                      {% if real_time_data.traffic.overall_city_congestion is
                      defined %}
                      <div class="alert alert-secondary mt-2 mb-0 py-2">
                        <p class="mb-0 small">
                          <strong>Overall City Status:</strong>
                          <span
                            class="badge {% if real_time_data.traffic.overall_city_congestion <= 3 %} bg-success {% elif real_time_data.traffic.overall_city_congestion <= 6 %} bg-warning {% else %} bg-danger {% endif %}"
                          >
                            {{
                            real_time_data.traffic.overall_city_congestion|default(5)
                            }}/10
                          </span>
                          {% if real_time_data.traffic.status is defined %} - {{
                          real_time_data.traffic.status }} {% endif %}
                        </p>
                      </div>
                      {% endif %}
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Festival/Events Information -->
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-header bg-success text-white">
                  <h5>
                    <i class="bi bi-calendar-event me-2"></i>Events & Festivals
                  </h5>
                </div>
                <div class="card-body">
                  <div id="festivalData">
                    <p class="mb-2">{{ real_time_summary.festivals }}</p>
                    {% if real_time_data.festivals %} {% set has_festival =
                    real_time_data.festivals.has_festival_today if
                    real_time_data.festivals.has_festival_today is defined else
                    false %} {% set festival_list =
                    real_time_data.festivals.festivals if
                    real_time_data.festivals.festivals is defined else [] %} {%
                    set today_str = now().strftime('%Y-%m-%d') %} {% if
                    has_festival and festival_list|length > 0 %}
                    <div class="mt-3">
                      {% for festival in festival_list %} {% if festival.date is
                      defined and festival.date == today_str %}
                      <div class="alert alert-success py-2 px-3 mb-2">
                        <p class="mb-1">
                          <strong>{{ festival.name|default('Event') }}</strong>
                        </p>
                        <p class="mb-1 small">
                          <i class="bi bi-geo-alt me-1"></i> {{
                          festival.location|default('Various locations') }}
                        </p>
                        <p class="mb-1 small">
                          <i class="bi bi-clock me-1"></i> {{
                          festival.time|default('All day') }}
                        </p>
                        <p class="mb-0 small">
                          {% set impact = festival.traffic_impact|default('Low')
                          %}
                          <span
                            class="badge bg-{{ 'success' if impact == 'Low' else 'warning' if impact == 'Moderate' else 'danger' }}"
                          >
                            {{ impact }} impact
                          </span>
                          {% if festival.affected_areas is defined and
                          festival.affected_areas|length > 0 %}
                          <span class="small ms-2">
                            <i class="bi bi-geo-fill me-1"></i>Affecting: {{
                            festival.affected_areas|join(', ') }}
                          </span>
                          {% endif %}
                        </p>
                      </div>
                      {% endif %} {% endfor %}
                    </div>
                    {% else %}
                    <div class="mt-3">
                      <div class="alert alert-light py-2 px-3 mb-0">
                        <div class="text-center py-2">
                          <i
                            class="bi bi-calendar-x text-muted"
                            style="font-size: 2rem"
                          ></i>
                          <p class="mb-0 mt-2">
                            No festivals or events scheduled for today
                          </p>
                        </div>
                      </div>
                    </div>
                    {% endif %} {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Left Column -->
        <div class="col-md-6">
          <!-- Prediction Section -->
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h4>Predict Optimal Delivery Times</h4>
            </div>
            <div class="card-body">
              <form id="predictionForm">
                <div class="mb-3">
                  <label for="name" class="form-label">Customer Name:</label>
                  <select class="form-select" id="name" name="name" required>
                    <option value="" selected disabled>
                      Select a customer
                    </option>
                    {% for name in names %}
                    <option value="{{ name }}">{{ name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="day" class="form-label">Day of Delivery:</label>
                  <select class="form-select" id="day" name="day">
                    <option value="{{ current_day }}" selected>
                      Today ({{ current_day }})
                    </option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                  </select>
                </div>

                <button type="submit" class="btn btn-primary">
                  Predict Optimal Times
                </button>
              </form>

              <div
                id="predictionResult"
                class="prediction-result"
                style="display: none"
              >
                <h5>
                  Optimal Delivery Times for <span id="customerName"></span> on
                  <span id="deliveryDay"></span>:
                </h5>
                <div id="optimalTimes" class="mt-3"></div>
              </div>
            </div>
          </div>

          <!-- Add New Order -->
          <div class="card mt-4">
            <div class="card-header bg-success text-white">
              <h4>Add New Order</h4>
            </div>
            <div class="card-body">
              <form id="newOrderForm">
                <div class="mb-3">
                  <label for="order_name" class="form-label"
                    >Customer Name:</label
                  >
                  <select
                    class="form-select"
                    id="order_name"
                    name="name"
                    required
                    onchange="updateAreaInfo()"
                  >
                    <option value="" selected disabled>
                      Select a customer
                    </option>
                    <option value="Aditya">Aditya (Satellite)</option>
                    <option value="Vivaan">Vivaan (Bopal)</option>
                    <option value="Aarav">Aarav (Vastrapur)</option>
                    <option value="Meera">Meera (Paldi)</option>
                    <option value="Diya">Diya (Thaltej)</option>
                    <option value="Riya">Riya (Navrangpura)</option>
                    <option value="Ananya">Ananya (Bodakdev)</option>
                    <option value="Aryan">Aryan (Gota)</option>
                    <option value="Ishaan">Ishaan (Maninagar)</option>
                    <option value="Kabir">Kabir (Chandkheda)</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="delivery_day" class="form-label"
                    >Day of Delivery:</label
                  >
                  <select
                    class="form-select"
                    id="delivery_day"
                    name="delivery_day"
                    required
                  >
                    <option value="{{ current_day }}">
                      Today ({{ current_day }})
                    </option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="customer_area" class="form-label">Area:</label>
                  <input
                    type="text"
                    class="form-control"
                    id="customer_area"
                    readonly
                    disabled
                  />
                  <small class="text-muted"
                    >Area is automatically assigned based on the customer</small
                  >
                </div>

                <div class="mb-3">
                  <label for="package_size" class="form-label"
                    >Package Size:</label
                  >
                  <select
                    class="form-select"
                    id="package_size"
                    name="package_size"
                    required
                  >
                    <option value="Small">Small</option>
                    <option value="Medium">Medium</option>
                    <option value="Large">Large</option>
                  </select>
                </div>

                <button type="submit" class="btn btn-success">Add Order</button>
              </form>

              <div
                id="orderResult"
                class="alert alert-success mt-3"
                style="display: none"
              >
                Order added successfully!
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-6">
          <!-- Route Optimization Section -->
          <div class="card mb-4">
            <div class="card-header bg-info text-white">
              <h4>Route Optimization</h4>
            </div>
            <div class="card-body">
              <p>Plan the most efficient delivery route for today's orders.</p>

              <form id="routeOptimizationForm">
                <div class="mb-3">
                  <label class="form-label"
                    >Select Customers for Today's Delivery Route:</label
                  >
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="selectAllCustomers"
                    />
                    <label class="form-check-label" for="selectAllCustomers">
                      Select All Today's Orders
                    </label>
                  </div>

                  <div id="todaysOrdersList" class="mt-2">
                    {% for order in grouped_todays_orders %}
                    <div class="form-check">
                      <input
                        class="form-check-input customer-checkbox"
                        type="checkbox"
                        name="selected_customers[]"
                        value="{{ order.name }}"
                        id="customer-{{ order.order_id }}"
                        data-count="{{ order.parcel_count }}"
                      />
                      <label
                        class="form-check-label"
                        for="customer-{{ order.order_id }}"
                      >
                        {{ order.name }} ({{ order.area }}) {% if
                        order.parcel_count > 1 %}
                        <span class="badge bg-primary"
                          >{{ order.parcel_count }} parcels</span
                        >
                        {% endif %}
                        <div class="customer-address">{{ order.address }}</div>
                      </label>
                    </div>
                    {% endfor %}
                  </div>
                </div>

                <button type="submit" class="btn btn-info">
                  Optimize Route
                </button>
              </form>

              <div
                id="routeLoadingIndicator"
                class="text-center my-4"
                style="display: none"
              >
                <div class="spinner-border text-info" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Calculating optimal delivery route...</p>
              </div>

              <div id="routeResult" class="mt-4" style="display: none">
                <h5>Optimal Delivery Route:</h5>
                <div class="alert alert-info">
                  <span id="routeSummary"></span>
                  <div id="totalDistance" class="mt-2"></div>
                </div>

                <div id="routeDetails"></div>

                <div id="routeMap" class="route-map"></div>

                <div class="mt-3 text-end">
                  <button id="resetRouteBtn" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-counterclockwise"></i> Plan New Route
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Pending Orders -->
          <div class="card">
            <div class="card-header bg-warning">
              <h4>Pending Orders ({{ pending_orders|length }})</h4>
            </div>
            <div class="card-body">
              <div class="list-group" id="ordersContainer">
                {% for group in grouped_pending_orders %}
                <div class="card order-card">
                  <div class="card-body">
                    <h5 class="card-title">
                      {{ group.name }} {% if group.orders|length > 1 %}
                      <span class="badge bg-primary"
                        >{{ group.orders|length }} parcels</span
                      >
                      {% endif %}
                    </h5>
                    <p class="card-text">
                      <strong>Delivery Day:</strong> {{ group.delivery_day }}<br />
                      <strong>Area:</strong> {{ group.area }}<br />
                      <strong>Address:</strong> {{ group.address }}<br />
                    </p>
                    <div class="mt-3">
                      <strong>Parcels:</strong>
                      <ul class="list-group mt-2">
                        {% for order in group.orders %}
                        <li
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>#{{ order.order_id }}</strong> - {{
                            order.package_size }} package
                            <span class="badge bg-warning ms-2"
                              >{{ order.status }}</span
                            >
                          </div>
                          <div class="btn-group" role="group">
                            <a
                              href="/mark_delivered/{{ order.order_id }}?success=true"
                              class="btn btn-success btn-sm"
                              >Delivered</a
                            >
                            <a
                              href="/mark_delivered/{{ order.order_id }}?success=false"
                              class="btn btn-danger btn-sm"
                              >Failed</a
                            >
                          </div>
                        </li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Chatbot Component -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div
              class="card-header bg-dark text-white d-flex justify-content-between align-items-center"
            >
              <h4>
                <i class="bi bi-chat-dots-fill me-2"></i> Delivery Assistant
              </h4>
              <button id="chatMinimize" class="btn btn-sm btn-outline-light">
                <i class="bi bi-dash-lg"></i>
              </button>
            </div>
            <div class="card-body" id="chatBody">
              <div
                id="chatMessages"
                class="mb-3"
                style="
                  height: 300px;
                  overflow-y: auto;
                  border: 1px solid #dee2e6;
                  border-radius: 5px;
                  padding: 10px;
                "
              >
                <div class="alert alert-info">
                  <i class="bi bi-robot me-2"></i> Hello! I'm your delivery
                  assistant. How can I help you today?
                </div>
              </div>

              <form id="chatForm" class="d-flex">
                <input
                  type="text"
                  id="chatInput"
                  class="form-control me-2"
                  placeholder="Ask me about deliveries, routes, or customers..."
                />
                <button type="submit" class="btn btn-dark">
                  <i class="bi bi-send-fill"></i>
                </button>
              </form>

              <div class="mt-2 text-muted small">
                <i class="bi bi-info-circle me-1"></i> Try asking about optimal
                delivery times, today's deliveries, or specific customers
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script>
      // Function to geocode address using Nominatim
      function geocodeAddress(address) {
        return new Promise((resolve, reject) => {
          const encodedAddress = encodeURIComponent(address);
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1`;

          fetch(url, {
            headers: {
              Accept: "application/json",
              "User-Agent": "DeliveryPredictionSystem/1.0",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data && data.length > 0) {
                const result = data[0];
                resolve([parseFloat(result.lat), parseFloat(result.lon)]);
              } else {
                reject(new Error("Address not found"));
              }
            })
            .catch((error) => {
              console.error("Geocoding error:", error);
              reject(error);
            });
        });
      }

      // Customer area mapping
      const customerAreas = {
        Aditya: "Satellite",
        Vivaan: "Bopal",
        Aarav: "Vastrapur",
        Meera: "Paldi",
        Diya: "Thaltej",
        Riya: "Navrangpura",
        Ananya: "Bodakdev",
        Aryan: "Gota",
        Ishaan: "Maninagar",
        Kabir: "Chandkheda",
      };

      function updateAreaInfo() {
        const customerName = document.getElementById("order_name").value;
        const areaField = document.getElementById("customer_area");

        if (customerName && customerAreas[customerName]) {
          areaField.value = customerAreas[customerName];
        } else {
          areaField.value = "";
        }
      }

      $(document).ready(function () {
        // Initialize area display
        updateAreaInfo();

        // Reset route planning
        $(document).on("click", "#resetRouteBtn", function () {
          // Clear checkboxes
          $(".customer-checkbox").prop("checked", false);
          $("#selectAllCustomers").prop("checked", false);

          // Hide route result
          $("#routeResult").hide();

          // Scroll back to the form
          $("html, body").animate(
            {
              scrollTop: $("#routeOptimizationForm").offset().top - 20,
            },
            500
          );
        });

        // Prediction form submission
        $("#predictionForm").submit(function (e) {
          e.preventDefault();

          $.ajax({
            url: "/predict",
            type: "POST",
            data: $(this).serialize(),
            success: function (data) {
              // Display optimal times
              $("#customerName").text(data.name);
              $("#deliveryDay").text(data.day);

              const optimalTimesContainer = $("#optimalTimes");
              optimalTimesContainer.empty();

              if (data.optimal_times && data.optimal_times.length > 0) {
                // Create a list of optimal times
                const optimalTimesList = $("<div class='list-group'></div>");

                data.optimal_times.forEach(function (prediction, index) {
                  // Create different badge colors based on failure rate
                  let badgeClass = "bg-success";
                  if (prediction.failure_rate > 5) {
                    badgeClass = "bg-warning";
                  }
                  if (prediction.failure_rate > 8) {
                    badgeClass = "bg-danger";
                  }

                  // Create a time item
                  const timeItem = $(`
                    <div class="list-group-item list-group-item-action">
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="time-badge badge ${badgeClass}">
                          ${prediction.time}
                        </span>
                        <small class="text-muted">
                          ${prediction.failure_rate}% failure risk
                        </small>
                      </div>
                    </div>
                  `);

                  optimalTimesList.append(timeItem);
                });

                optimalTimesContainer.append(optimalTimesList);

                // Add real-time factors that influenced the prediction if available
                if (
                  data.real_time_factors &&
                  Object.keys(data.real_time_factors).length > 0
                ) {
                  const realTimeFactors =
                    $(`<div class="mt-3 p-2 bg-light rounded">
                    <h6><i class="bi bi-lightning-fill me-1 text-warning"></i>Real-time factors affecting this prediction:</h6>
                    <ul class="list-unstyled small m-0"></ul>
                  </div>`);

                  const factorsList = realTimeFactors.find("ul");

                  if (data.real_time_factors.traffic) {
                    const traffic = data.real_time_factors.traffic;
                    let icon = "bi-sign-intersection-fill";
                    let color = "text-success";

                    if (
                      traffic.congestion_level > 3 &&
                      traffic.congestion_level <= 6
                    ) {
                      color = "text-warning";
                    } else if (traffic.congestion_level > 6) {
                      color = "text-danger";
                    }

                    factorsList.append(
                      `<li><i class="bi ${icon} ${color} me-1"></i>Traffic: Congestion level ${traffic.congestion_level}/10 - ${traffic.status}</li>`
                    );
                  }

                  if (data.real_time_factors.weather) {
                    const weather = data.real_time_factors.weather;
                    let icon = "bi-cloud";
                    let color = "text-primary";

                    if (
                      weather.conditions.toLowerCase().includes("rain") ||
                      weather.precipitation > 50
                    ) {
                      icon = "bi-cloud-rain-fill";
                      color = "text-primary";
                    } else if (weather.temperature > 35) {
                      icon = "bi-thermometer-high";
                      color = "text-danger";
                    }

                    factorsList.append(
                      `<li><i class="bi ${icon} ${color} me-1"></i>Weather: ${weather.conditions}, ${weather.temperature}Â°C, ${weather.precipitation}% precipitation chance</li>`
                    );
                  }

                  if (data.real_time_factors.festival) {
                    const festival = data.real_time_factors.festival;
                    let icon = "bi-calendar-event";
                    let color = "text-success";

                    if (festival.impact === "Moderate") {
                      color = "text-warning";
                    } else if (
                      festival.impact === "High" ||
                      festival.impact === "Severe"
                    ) {
                      color = "text-danger";
                    }

                    factorsList.append(
                      `<li><i class="bi ${icon} ${color} me-1"></i>Event: ${festival.name} (${festival.impact} impact)</li>`
                    );
                  }

                  optimalTimesContainer.append(realTimeFactors);
                }
              } else {
                // No optimal times available
                optimalTimesContainer.html(
                  "<div class='alert alert-warning'>No optimal delivery times found for this customer.</div>"
                );
              }

              // Show the result
              $("#predictionResult").show();
            },
            error: function (xhr, status, error) {
              alert("Error predicting optimal times: " + error);
            },
          });
        });

        // New order form submission
        $("#newOrderForm").submit(function (e) {
          e.preventDefault();

          $.ajax({
            url: "/add_order",
            type: "POST",
            data: $(this).serialize(),
            success: function (response) {
              $("#orderResult").show().delay(3000).fadeOut();
              setTimeout(function () {
                location.reload();
              }, 3000);
            },
          });
        });

        // Select/deselect all customers
        $("#selectAllCustomers").change(function () {
          $(".customer-checkbox").prop("checked", $(this).prop("checked"));
        });

        // Route optimization form submission
        $("#routeOptimizationForm").submit(function (e) {
          e.preventDefault();

          // Get selected customers with counts
          const selectedCustomers = [];
          $(".customer-checkbox:checked").each(function () {
            const customerName = $(this).val();
            const count = parseInt($(this).data("count") || 1);

            // Add the customer to the list based on the parcel count
            for (let i = 0; i < count; i++) {
              selectedCustomers.push(customerName);
            }
          });

          // Show loading indicator
          $("#routeLoadingIndicator").show();
          $("#routeResult").hide();

          // Build the form data
          const formData = new FormData();
          selectedCustomers.forEach((name) => {
            formData.append("selected_customers[]", name);
          });

          $.ajax({
            url: "/optimize_route",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
              // Hide loading indicator
              $("#routeLoadingIndicator").hide();

              // Display route summary
              $("#routeSummary").html(
                `Optimal delivery order: <strong>${response.route.join(
                  " â†’ "
                )}</strong>`
              );

              // Display distance and time
              let routeSummaryHtml = `Total distance: <strong>${response.total_distance}</strong>`;
              if (response.total_duration) {
                routeSummaryHtml += `, Estimated time: <strong>${response.total_duration}</strong>`;
              }
              $("#totalDistance").html(routeSummaryHtml);

              // Display real-time conditions affecting the route
              let realTimeInfoHtml = "";

              if (response.weather_conditions) {
                realTimeInfoHtml += `
                  <div class="alert alert-info py-2 mt-2">
                    <p class="mb-1"><i class="bi bi-cloud me-2"></i><strong>Weather:</strong> ${response.weather_conditions}</p>
                  </div>`;
              }

              if (response.traffic_summary) {
                realTimeInfoHtml += `
                  <div class="alert alert-warning py-2">
                    <p class="mb-1"><i class="bi bi-sign-intersection-fill me-2"></i><strong>Traffic:</strong> ${response.traffic_summary}</p>
                  </div>`;
              }

              if (
                response.festival_impact &&
                response.festival_impact !==
                  "No festivals or events affecting deliveries today"
              ) {
                realTimeInfoHtml += `
                  <div class="alert alert-success py-2">
                    <p class="mb-1"><i class="bi bi-calendar-event me-2"></i><strong>Events:</strong> ${response.festival_impact}</p>
                  </div>`;
              }

              if (realTimeInfoHtml) {
                $("#totalDistance").after(`
                  <div id="realTimeFactors" class="mt-2">
                    <h6>Real-time conditions affecting this route:</h6>
                    ${realTimeInfoHtml}
                  </div>
                `);
              }

              // Display detailed route
              let routeDetailsHtml = "";
              response.details.forEach(function (leg, index) {
                // Determine traffic status badge color
                let trafficBadgeClass = "bg-success";
                if (leg.traffic_conditions) {
                  if (
                    leg.traffic_conditions.includes("Heavy") ||
                    leg.traffic_conditions.includes("Severe")
                  ) {
                    trafficBadgeClass = "bg-danger";
                  } else if (
                    leg.traffic_conditions.includes("Moderate") ||
                    leg.traffic_conditions.includes("Wet Roads") ||
                    leg.traffic_conditions.includes("Festival")
                  ) {
                    trafficBadgeClass = "bg-warning";
                  }
                }

                routeDetailsHtml += `
                  <div class="route-segment">
                    <div class="fw-bold">Leg ${index + 1}: ${leg.from} â†’ ${
                  leg.to
                }</div>
                    <div class="mt-1">
                      <span class="badge bg-secondary me-2">Distance: ${
                        leg.distance
                      }</span>
                      <span class="badge bg-secondary">Duration: ${
                        leg.duration
                      }</span>
                      ${
                        leg.traffic_conditions
                          ? `<span class="badge ${trafficBadgeClass} ms-2">${leg.traffic_conditions}</span>`
                          : ""
                      }
                    </div>
                    <div class="customer-address mt-2">
                      <div><small>From: ${leg.from_address}</small></div>
                      <div><small>To: ${leg.to_address}</small></div>
                    </div>
                  </div>
                `;
              });

              $("#routeDetails").html(routeDetailsHtml);

              // Initialize route map using Leaflet
              initRouteMap(response);

              // Show the result section
              $("#routeResult").show();
            },
            error: function (error) {
              // Hide loading indicator and show error
              $("#routeLoadingIndicator").hide();
              alert(
                "An error occurred while optimizing the route. Please try again."
              );
              console.error("Route optimization error:", error);
            },
          });
        });

        // Function to initialize the route map using Leaflet
        function initRouteMap(routeData) {
          // Clear any existing map
          $("#routeMap").empty();
          $("#routeMap").html('<div id="map" style="height: 400px;"></div>');

          // Define coordinates for Ahmedabad areas (accurate)
          const areaCoordinates = {
            Satellite: [23.030357, 72.517845],
            Bopal: [23.032011, 72.467816],
            Vastrapur: [23.0362554310379, 72.5305526298169],
            Paldi: [23.013054, 72.562515],
            Thaltej: [23.049736, 72.511726],
            Navrangpura: [23.036406, 72.561066],
            Bodakdev: [23.0394524, 72.512492],
            Gota: [23.104, 72.5399],
            Maninagar: [22.99617, 72.599586],
            Chandkheda: [23.11842, 72.586777],
            "Start Location (Postman)": [23.0269, 72.5297], // Iscon Center, Shivranjani Cross Road coordinates
          };

          // Define customer address coordinates for Leaflet geocoding
          const customerAddresses = {
            Aditya: {
              address:
                "Near Jodhpur Cross Road, Satellite, Ahmedabad, Gujarat, India",
              area: "Satellite",
              coords: [23.030357, 72.517845],
              geocodeAddress: "Satellite, Ahmedabad, Gujarat, India",
            },
            Vivaan: {
              address: "Near Bopal Cross Road, Bopal, Ahmedabad - 380058",
              area: "Bopal",
              coords: [23.032011, 72.467816],
              geocodeAddress: "Bopal, Ahmedabad, Gujarat, India",
            },
            Aarav: {
              address: "Near Vastrapur Lake, Vastrapur, Ahmedabad - 380015",
              area: "Vastrapur",
              coords: [23.0362554310379, 72.5305526298169],
              geocodeAddress: "Vastrapur, Ahmedabad, Gujarat, India",
            },
            Meera: {
              address: "Opposite Dharnidhar Derasar, Paldi, Ahmedabad - 380007",
              area: "Paldi",
              coords: [23.013054, 72.562515],
              geocodeAddress: "Paldi, Ahmedabad, Gujarat, India",
            },
            Diya: {
              address:
                "Near Thaltej Cross Road, S.G. Highway, Ahmedabad - 380054",
              area: "Thaltej",
              coords: [23.049736, 72.511726],
              geocodeAddress: "Thaltej, Ahmedabad, Gujarat, India",
            },
            Riya: {
              address:
                "Near Navrangpura AMTS Bus Stop, Navrangpura, Ahmedabad - 380009",
              area: "Navrangpura",
              coords: [23.036406, 72.561066],
              geocodeAddress: "Navrangpura, Ahmedabad, Gujarat, India",
            },
            Ananya: {
              address: "Opposite Rajpath Club, Bodakdev, Ahmedabad - 380054",
              area: "Bodakdev",
              coords: [23.0394524, 72.512492],
              geocodeAddress: "Bodakdev, Ahmedabad, Gujarat, India",
            },
            Aryan: {
              address: "Near Oganaj Gam, Gota, Ahmedabad - 382481",
              area: "Gota",
              coords: [23.104, 72.5399],
              geocodeAddress: "Gota, Ahmedabad, Gujarat, India",
            },
            Ishaan: {
              address:
                "Opposite Rambaug Police Station, Maninagar, Ahmedabad - 380008",
              area: "Maninagar",
              coords: [22.99617, 72.599586],
              geocodeAddress: "Maninagar, Ahmedabad, Gujarat, India",
            },
            Kabir: {
              address:
                "Near Chandkheda Gam Bus Stop, Chandkheda, Ahmedabad - 382424",
              area: "Chandkheda",
              coords: [23.11842, 72.586777],
              geocodeAddress: "Chandkheda, Ahmedabad, Gujarat, India",
            },
            "Start Location (Postman)": {
              address:
                "Iscon Center, Shivranjani Cross Road, Satellite, Ahmedabad, India",
              area: "Satellite",
              coords: [23.0269, 72.5297],
              geocodeAddress:
                "Iscon Center, Shivranjani Cross Road, Satellite, Ahmedabad, India",
            },
          };

          // Initialize map centered on postman's location (Satellite)
          const defaultCenter = [23.0225, 72.5714]; // Ahmedabad center as fallback
          let postmanLocation;

          try {
            // Get postman location with validation
            const rawLocation = areaCoordinates["Start Location (Postman)"];
            if (
              rawLocation &&
              Array.isArray(rawLocation) &&
              rawLocation.length === 2 &&
              !isNaN(parseFloat(rawLocation[0])) &&
              !isNaN(parseFloat(rawLocation[1]))
            ) {
              // Parse as floats for stability
              postmanLocation = [
                parseFloat(rawLocation[0]),
                parseFloat(rawLocation[1]),
              ];
            } else {
              console.warn(
                "Invalid postman location in data, using default:",
                rawLocation
              );
              postmanLocation = defaultCenter;
            }
          } catch (error) {
            console.error("Error setting postman location:", error);
            postmanLocation = defaultCenter;
          }

          // Create the map with validated location
          const map = L.map("map").setView(postmanLocation, 15);

          // Set max bounds to Ahmedabad region to prevent excessive panning
          const southWest = L.latLng(22.9, 72.4);
          const northEast = L.latLng(23.2, 72.7);
          map.setMaxBounds(L.latLngBounds(southWest, northEast));

          // Add OpenStreetMap tile layer
          L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "Â© OpenStreetMap",
          }).addTo(map);

          // Create start icon for postman location
          const startIcon = L.divIcon({
            className: "custom-div-icon",
            html: `<div style="background-color: #198754; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 3px solid white; font-size: 16px;">S</div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 18],
          });

          // Store markers and selected locations
          const markers = {};
          const selectedLocations = {};
          let waypoints = [];

          // Add start location marker (with validation)
          let startMarker;
          try {
            const startLocation = L.latLng(
              postmanLocation[0],
              postmanLocation[1]
            );
            startMarker = L.marker(startLocation, { icon: startIcon })
              .addTo(map)
              .bindPopup(
                '<div style="text-align: center;"><b>Start Location (Postman)</b></div><hr style="margin: 5px 0;"><div>Iscon Center, Shivranjani Cross Road</div><div style="font-size: 0.9em; margin-top: 5px; color: #198754;">All routes start here</div>'
              );

            // Open postman popup by default
            startMarker.openPopup();

            // Add a circle around the starting location
            L.circle(startLocation, {
              color: "#198754",
              fillColor: "#198754",
              fillOpacity: 0.15,
              radius: 200,
              weight: 2,
            }).addTo(map);

            // Add start location to waypoints (with validation)
            waypoints.push(startLocation);
          } catch (error) {
            console.error("Error creating start marker:", error);
            // Create fallback marker at Ahmedabad center
            const fallbackLocation = L.latLng(23.0225, 72.5714);
            startMarker = L.marker(fallbackLocation, { icon: startIcon })
              .addTo(map)
              .bindPopup(
                '<div style="text-align: center;"><b>Start Location (Postman)</b></div><hr style="margin: 5px 0;"><div>Iscon Center, Shivranjani Cross Road</div><div style="font-size: 0.9em; margin-top: 5px; color: #198754;">Fallback location</div>'
              );

            // Add fallback circle
            L.circle(fallbackLocation, {
              color: "#198754",
              fillColor: "#198754",
              fillOpacity: 0.15,
              radius: 200,
              weight: 2,
            }).addTo(map);

            // Add fallback location to waypoints
            waypoints.push(fallbackLocation);
          }

          // Process route data
          if (routeData && routeData.details && routeData.details.length > 0) {
            // Process each delivery location from route data
            routeData.details.forEach((leg, index) => {
              const toName = leg.to;
              // Extract customer name without parcel count
              let customerName = toName.split(" (")[0].trim();

              // Find the coordinates from customerAddresses if available
              let coords = null;
              let geocodingAttempted = false;

              try {
                if (customerName in customerAddresses) {
                  coords = customerAddresses[customerName].coords;

                  // Check if coordinates are valid
                  const validCoords =
                    coords &&
                    coords.length === 2 &&
                    !isNaN(coords[0]) &&
                    !isNaN(coords[1]) &&
                    Math.abs(coords[0]) <= 90 &&
                    Math.abs(coords[1]) <= 180;

                  if (!validCoords) {
                    console.warn(
                      `Invalid coordinates for ${customerName}: [${coords}], trying geocoding`
                    );

                    // Try geocoding with the generalized address
                    const geocodeAddr =
                      customerAddresses[customerName].geocodeAddress ||
                      `${customerAddresses[customerName].area}, Ahmedabad, Gujarat, India`;

                    // Use promise to attempt geocoding
                    geocodingAttempted = true;
                    geocodeAddress(geocodeAddr)
                      .then((geocodedCoords) => {
                        console.log(
                          `Successfully geocoded ${customerName} to [${geocodedCoords}]`
                        );
                        coords = geocodedCoords;

                        // Create marker and add to map with the geocoded coordinates
                        addDeliveryMarker(customerName, leg, coords, index);
                      })
                      .catch((error) => {
                        console.error(
                          `Geocoding failed for ${customerName}: ${error.message}`
                        );
                        // Use Ahmedabad center as fallback
                        coords = [23.0225, 72.5714];

                        // Create marker with fallback coordinates
                        addDeliveryMarker(customerName, leg, coords, index);
                      });
                  }
                } else {
                  // Find the exact case for the customer name in the coordinates object
                  const exactCustomerName =
                    Object.keys(areaCoordinates).find(
                      (key) => key.toLowerCase() === customerName.toLowerCase()
                    ) || customerName;

                  // Get coordinates for this customer
                  coords = areaCoordinates[exactCustomerName];

                  // If still no coordinates found, use geocoding based on address
                  if (!coords && leg.to_address) {
                    console.log(
                      `No coordinates found for ${customerName}, attempting to use address: ${leg.to_address}`
                    );

                    // Extract area name from address if possible
                    const addressAreaMatch = leg.to_address.match(
                      /\b(Satellite|Bopal|Vastrapur|Paldi|Thaltej|Navrangpura|Bodakdev|Gota|Maninagar|Chandkheda)\b/i
                    );

                    if (addressAreaMatch) {
                      const extractedArea = addressAreaMatch[1];
                      console.log(
                        `Found area name in address: ${extractedArea}`
                      );

                      // Find the exact area name with proper case
                      const exactAreaName = Object.keys(areaCoordinates).find(
                        (key) =>
                          key.toLowerCase() === extractedArea.toLowerCase()
                      );

                      if (exactAreaName) {
                        coords = areaCoordinates[exactAreaName];
                        console.log(
                          `Using coordinates for area ${exactAreaName}: [${coords}]`
                        );
                      }
                    }

                    // If still no coordinates, try geocoding the address directly
                    if (!coords) {
                      // Simplify address for geocoding
                      let geocodingAddress = leg.to_address;
                      const areaMatch = leg.to_address.match(
                        /\b([A-Za-z]+),\s*Ahmedabad/i
                      );
                      if (areaMatch) {
                        geocodingAddress = `${areaMatch[1]}, Ahmedabad, Gujarat, India`;
                      } else {
                        geocodingAddress = "Ahmedabad, Gujarat, India";
                      }

                      // Use promise to attempt geocoding
                      geocodingAttempted = true;
                      geocodeAddress(geocodingAddress)
                        .then((geocodedCoords) => {
                          console.log(
                            `Successfully geocoded address to [${geocodedCoords}]`
                          );
                          coords = geocodedCoords;

                          // Create marker and add to map with the geocoded coordinates
                          addDeliveryMarker(customerName, leg, coords, index);
                        })
                        .catch((error) => {
                          console.error(`Geocoding failed: ${error.message}`);
                          // Use Ahmedabad center as fallback
                          coords = [23.0225, 72.5714];

                          // Create marker with fallback coordinates
                          addDeliveryMarker(customerName, leg, coords, index);
                        });
                    }
                  }
                }

                // Helper function to add a delivery marker to the map
                function addDeliveryMarker(customerName, leg, coords, index) {
                  if (
                    coords &&
                    coords.length === 2 &&
                    !isNaN(coords[0]) &&
                    !isNaN(coords[1]) &&
                    Math.abs(coords[0]) <= 90 &&
                    Math.abs(coords[1]) <= 180
                  ) {
                    // Check if name contains parcel count information
                    const toName = leg.to;
                    const hasMultipleParcels = toName.includes("parcels");
                    const parcelCount = hasMultipleParcels
                      ? parseInt(toName.match(/\((\d+) parcels\)/)[1])
                      : 1;

                    // Create numbered icon
                    const deliveryIcon = L.divIcon({
                      className: "custom-div-icon",
                      html: `<div style="background-color: #0d6efd; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white;">${
                        index + 1
                      }</div>`,
                      iconSize: [28, 28],
                      iconAnchor: [14, 14],
                      popupAnchor: [0, -10],
                    });

                    // Add popup content
                    let popupContent = `<div style="text-align: center;"><b>${toName}</b></div>`;
                    popupContent += `<hr style="margin: 5px 0;">`;
                    popupContent += `<b>Address:</b> ${leg.to_address}<br>`;
                    popupContent += `<b>Distance:</b> ${leg.distance}<br>`;
                    popupContent += `<b>Duration:</b> ${leg.duration}`;

                    // Create marker and add to map
                    const marker = L.marker(coords, { icon: deliveryIcon })
                      .addTo(map)
                      .bindPopup(popupContent, { maxWidth: 300 });

                    // Mark this location as selected and add to waypoints
                    const areaName =
                      customerName in customerAddresses
                        ? customerAddresses[customerName].area
                        : Object.keys(areaCoordinates).find(
                            (key) =>
                              key.toLowerCase() === customerName.toLowerCase()
                          );

                    if (areaName) selectedLocations[areaName] = true;

                    // Validate coordinates before creating the waypoint
                    if (
                      coords &&
                      coords.length === 2 &&
                      !isNaN(coords[0]) &&
                      !isNaN(coords[1]) &&
                      Math.abs(coords[0]) <= 90 &&
                      Math.abs(coords[1]) <= 180
                    ) {
                      waypoints.push(L.latLng(coords[0], coords[1]));
                    } else {
                      console.error(
                        `Invalid coordinates for ${customerName}: [${coords}], skipping waypoint`
                      );
                    }

                    // Store marker reference
                    markers[areaName] = {
                      marker: marker,
                      coords: coords,
                      name: toName,
                      address: leg.to_address,
                      index: index + 1,
                    };
                  }
                }
              } catch (error) {
                console.error(
                  `Error processing location for ${customerName}:`,
                  error
                );
              }

              // If not using geocoding (which is async), add the marker directly
              if (!geocodingAttempted && coords) {
                addDeliveryMarker(customerName, leg, coords, index);
              }
            });

            // Create the optimized route using Leaflet Routing Machine
            if (waypoints.length >= 2) {
              try {
                // Only use Routing Machine if available
                if (typeof L.Routing !== "undefined") {
                  const routingControl = L.Routing.control({
                    waypoints: waypoints,
                    routeWhileDragging: false,
                    showAlternatives: false,
                    fitSelectedRoutes: false,
                    show: false, // Don't show the instructions panel
                    lineOptions: {
                      styles: [
                        { color: "black", opacity: 0.15, weight: 7 },
                        { color: "#0d6efd", opacity: 0.8, weight: 5 },
                      ],
                      extendToWaypoints: true,
                      missingRouteTolerance: 100,
                    },
                    // Use OSRM as router if available
                    router: L.Routing.osrm
                      ? L.Routing.osrm({
                          serviceUrl:
                            "https://router.project-osrm.org/route/v1",
                          profile: "driving",
                        })
                      : undefined,
                    createMarker: function () {
                      // Don't create default markers, we have our own
                      return null;
                    },
                  }).addTo(map);

                  // Add direction arrows to the routing machine route
                  routingControl.on("routesfound", function (e) {
                    const routes = e.routes;
                    const summary = routes[0].summary;

                    // Create simplified version of the route for arrows
                    if (typeof L.polylineDecorator !== "undefined") {
                      try {
                        const routeCoords = routes[0].coordinates;
                        const simplifiedRoute = L.polyline(routeCoords, {
                          color: "#0d6efd",
                          opacity: 0,
                          weight: 5,
                        }).addTo(map);

                        const arrowDecorator = L.polylineDecorator(
                          simplifiedRoute,
                          {
                            patterns: [
                              {
                                offset: "10%",
                                repeat: "25%",
                                symbol: L.Symbol.arrowHead({
                                  pixelSize: 12,
                                  headAngle: 45,
                                  polygon: true,
                                  pathOptions: {
                                    color: "#0d6efd",
                                    fillColor: "#0d6efd",
                                    fillOpacity: 1,
                                    weight: 0,
                                  },
                                }),
                              },
                            ],
                          }
                        ).addTo(map);
                      } catch (error) {
                        console.error(
                          "Error adding direction arrows to routing machine path:",
                          error
                        );
                      }
                    }
                  });

                  // Hide the routing control container
                  setTimeout(() => {
                    const container = document.querySelector(
                      ".leaflet-routing-container"
                    );
                    if (container) {
                      container.style.display = "none";
                    }
                  }, 100);
                } else {
                  // Fallback to simple polyline if Routing Machine isn't available
                  const routeLine = L.polyline(waypoints, {
                    color: "#0d6efd",
                    weight: 4,
                    opacity: 0.8,
                  }).addTo(map);

                  // Add directional arrows to the fallback polyline
                  if (typeof L.polylineDecorator !== "undefined") {
                    try {
                      const arrowDecorator = L.polylineDecorator(routeLine, {
                        patterns: [
                          {
                            offset: "10%",
                            repeat: "25%",
                            symbol: L.Symbol.arrowHead({
                              pixelSize: 12,
                              headAngle: 45,
                              polygon: true,
                              pathOptions: {
                                color: "#0d6efd",
                                fillColor: "#0d6efd",
                                fillOpacity: 1,
                                weight: 0,
                              },
                            }),
                          },
                        ],
                      }).addTo(map);
                    } catch (error) {
                      console.error("Error creating direction arrows:", error);
                    }
                  }
                }

                // Fit map to show all delivery points with smaller padding
                try {
                  if (waypoints.length >= 2) {
                    const bounds = L.latLngBounds(waypoints);
                    map.fitBounds(bounds.pad(0.1));
                  } else if (waypoints.length === 1) {
                    // If there's only one waypoint, center on it
                    map.setView(waypoints[0], 15);
                  } else {
                    // If no valid waypoints, center on Ahmedabad
                    map.setView([23.0225, 72.5714], 12);
                  }
                } catch (error) {
                  console.error("Error fitting bounds to waypoints:", error);
                  // Fallback to Ahmedabad center
                  map.setView([23.0225, 72.5714], 12);
                }

                // Add directional arrows to the route using Polyline Decorator
                if (typeof L.polylineDecorator !== "undefined") {
                  try {
                    // Create simple polyline for the arrows
                    const routeLine = L.polyline(waypoints, {
                      color: "#0d6efd",
                      weight: 4,
                      opacity: 0, // Make the base line invisible
                    }).addTo(map);

                    // Add arrows to the route
                    const arrowDecorator = L.polylineDecorator(routeLine, {
                      patterns: [
                        {
                          offset: "10%",
                          repeat: "25%",
                          symbol: L.Symbol.arrowHead({
                            pixelSize: 12,
                            headAngle: 45,
                            polygon: true,
                            pathOptions: {
                              color: "#0d6efd",
                              fillColor: "#0d6efd",
                              fillOpacity: 1,
                              weight: 0,
                            },
                          }),
                        },
                      ],
                    }).addTo(map);
                  } catch (error) {
                    console.error("Error creating direction arrows:", error);
                  }
                }

                // Create a control to show route summary
                const summaryControl = L.control({ position: "bottomright" });
                summaryControl.onAdd = function () {
                  const div = L.DomUtil.create("div", "route-summary");
                  div.innerHTML = `
                    <div style="background-color: white; padding: 8px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.4); max-width: 250px;">
                      <div style="font-weight: bold; margin-bottom: 5px; color: #0d6efd;">Delivery Route Summary</div>
                      <div><b>Total Distance:</b> ${
                        routeData.total_distance
                      }</div>
                      <div><b>Delivery Stops:</b> ${waypoints.length - 1}</div>
                      <div style="font-size: 0.9em; margin-top: 5px; color: #666;">Numbers show delivery order</div>
                    </div>
                  `;
                  return div;
                };
                summaryControl.addTo(map);

                // Add a control button to go back to start location
                const backToStartControl = L.control({ position: "topleft" });
                backToStartControl.onAdd = function () {
                  const div = L.DomUtil.create("div", "back-to-start-control");
                  div.innerHTML = `
                    <button id="back-to-start-btn" class="btn btn-success" 
                      style="padding: 6px 12px; font-size: 14px; margin: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                      <i class="bi bi-geo-alt-fill"></i> Go to Starting Point
                    </button>
                  `;
                  return div;
                };
                backToStartControl.addTo(map);

                // Function to return to starting point (defined within initRouteMap for proper scope)
                function returnToStart() {
                  try {
                    if (startMarker && startMarker._latlng) {
                      map.flyTo(startMarker._latlng, 15);
                      if (startMarker.openPopup) {
                        startMarker.openPopup();
                      }
                    } else {
                      console.warn(
                        "Start marker not properly initialized, flying to default center"
                      );
                      map.flyTo([23.0225, 72.5714], 15);
                    }
                  } catch (error) {
                    console.error("Error in returnToStart function:", error);
                    // Fallback to Ahmedabad center
                    map.flyTo([23.0225, 72.5714], 15);
                  }
                }

                // Add event listener for the back to start button
                setTimeout(() => {
                  const backToStartBtn =
                    document.getElementById("back-to-start-btn");
                  if (backToStartBtn) {
                    backToStartBtn.addEventListener("click", function () {
                      returnToStart();
                    });
                  }
                }, 100);
              } catch (error) {
                console.error("Error creating route:", error);

                // Fallback to simple polyline if Routing Machine fails
                const routeLine = L.polyline(waypoints, {
                  color: "#0d6efd",
                  weight: 4,
                  opacity: 0.8,
                }).addTo(map);

                // Add directional arrows to the fallback polyline
                if (typeof L.polylineDecorator !== "undefined") {
                  try {
                    const arrowDecorator = L.polylineDecorator(routeLine, {
                      patterns: [
                        {
                          offset: "10%",
                          repeat: "25%",
                          symbol: L.Symbol.arrowHead({
                            pixelSize: 12,
                            headAngle: 45,
                            polygon: true,
                            pathOptions: {
                              color: "#0d6efd",
                              fillColor: "#0d6efd",
                              fillOpacity: 1,
                              weight: 0,
                            },
                          }),
                        },
                      ],
                    }).addTo(map);
                  } catch (error) {
                    console.error("Error creating direction arrows:", error);
                  }
                }

                // Fit map to show all delivery points with smaller padding
                try {
                  if (waypoints.length >= 2) {
                    const bounds = L.latLngBounds(waypoints);
                    map.fitBounds(bounds.pad(0.1));
                  } else if (waypoints.length === 1) {
                    // If there's only one waypoint, center on it
                    map.setView(waypoints[0], 15);
                  } else {
                    // If no valid waypoints, center on Ahmedabad
                    map.setView([23.0225, 72.5714], 12);
                  }
                } catch (error) {
                  console.error("Error fitting bounds to waypoints:", error);
                  // Fallback to Ahmedabad center
                  map.setView([23.0225, 72.5714], 12);
                }
              }
            } else {
              // If no route data provided, show interactive map with selectable locations

              // Add markers for all available delivery areas
              Object.entries(areaCoordinates).forEach(([areaName, coords]) => {
                // Skip the start location as we've already added it
                if (areaName === "Start Location (Postman)") return;

                // Find customers in this area to include in the popup
                const customersInArea = Object.entries(customerAddresses)
                  .filter(([_, data]) => data.area === areaName)
                  .map(([name, _]) => name);

                const areaIcon = L.divIcon({
                  className: "custom-div-icon",
                  html: `<div style="background-color: #6c757d; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white;"></div>`,
                  iconSize: [24, 24],
                  iconAnchor: [12, 12],
                });

                // Create marker with popup containing checkbox for selection
                const marker = L.marker(coords, { icon: areaIcon }).addTo(map);

                const popupContent = `
                  <div style="text-align: center;">
                    <b>${areaName}</b>
                    ${
                      customersInArea.length > 0
                        ? `<div class="text-muted small mt-1">${customersInArea.join(
                            ", "
                          )}</div>`
                        : ""
                    }
                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" id="select-${areaName}" 
                        onchange="toggleLocation('${areaName}')">
                      <label class="form-check-label" for="select-${areaName}">
                        Add to delivery route
                      </label>
                    </div>
                  </div>
                `;

                marker.bindPopup(popupContent);

                // Store marker reference
                markers[areaName] = {
                  marker: marker,
                  coords: coords,
                  name: areaName,
                  selected: false,
                  customers: customersInArea,
                };
              });

              // Add a control button to optimize route
              const optimizeControl = L.control({ position: "topright" });
              optimizeControl.onAdd = function () {
                const div = L.DomUtil.create("div", "optimize-control");
                div.innerHTML = `
                  <button id="optimize-route-btn" class="btn btn-primary" 
                    style="padding: 6px 12px; font-size: 14px; margin: 5px;">
                    Optimize Route
                  </button>
                `;
                return div;
              };
              optimizeControl.addTo(map);

              // Add a control button to go back to start location
              const backToStartControl = L.control({ position: "topleft" });
              backToStartControl.onAdd = function () {
                const div = L.DomUtil.create("div", "back-to-start-control");
                div.innerHTML = `
                  <button id="back-to-start-btn" class="btn btn-success" 
                    style="padding: 6px 12px; font-size: 14px; margin: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                    <i class="bi bi-geo-alt-fill"></i> Go to Starting Point
                  </button>
                `;
                return div;
              };
              backToStartControl.addTo(map);

              // Add event listener for the back to start button
              setTimeout(() => {
                const backToStartBtn =
                  document.getElementById("back-to-start-btn");
                if (backToStartBtn) {
                  backToStartBtn.addEventListener("click", function () {
                    returnToStart();
                  });
                }
              }, 100);

              // Define global function to toggle location selection
              window.toggleLocation = function (areaName) {
                const locationInfo = markers[areaName];
                const checkbox = document.getElementById(`select-${areaName}`);

                if (checkbox && checkbox.checked) {
                  // Select this location
                  locationInfo.selected = true;

                  // Change icon to show selection
                  const selectedIcon = L.divIcon({
                    className: "custom-div-icon",
                    html: `<div style="background-color: #dc3545; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white;"></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                  });

                  locationInfo.marker.setIcon(selectedIcon);
                } else {
                  // Deselect this location
                  locationInfo.selected = false;

                  // Change icon back to default
                  const defaultIcon = L.divIcon({
                    className: "custom-div-icon",
                    html: `<div style="background-color: #6c757d; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white;"></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                  });

                  locationInfo.marker.setIcon(defaultIcon);
                }

                updateSelectedCount();
              };

              // Helper function to update selected count
              function updateSelectedCount() {
                const selectedCount = Object.values(markers).filter(
                  (m) => m.selected
                ).length;
                const btn = document.getElementById("optimize-route-btn");
                if (btn) {
                  btn.textContent = `Optimize Route (${selectedCount} selected)`;
                  btn.disabled = selectedCount === 0;
                }
              }

              // Initialize state
              updateSelectedCount();

              // Preselect at least one location for demo purposes
              if (
                Object.values(markers).filter((m) => m.selected).length === 0
              ) {
                // Default select Satellite area for demonstration
                const defaultArea = "Satellite";
                if (markers[defaultArea]) {
                  markers[defaultArea].selected = true;
                  const checkbox = document.getElementById(
                    `select-${defaultArea}`
                  );
                  if (checkbox) checkbox.checked = true;

                  // Update marker appearance
                  const selectedIcon = L.divIcon({
                    className: "custom-div-icon",
                    html: `<div style="background-color: #dc3545; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white;"></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                  });

                  markers[defaultArea].marker.setIcon(selectedIcon);
                  updateSelectedCount();
                }
              }

              // Add event listener for optimize button
              setTimeout(() => {
                const optimizeBtn =
                  document.getElementById("optimize-route-btn");
                if (optimizeBtn) {
                  optimizeBtn.addEventListener("click", function () {
                    const selectedLocations = Object.entries(markers)
                      .filter(([name, info]) => info.selected)
                      .map(([name, info]) => name);

                    if (selectedLocations.length === 0) {
                      alert("Please select at least one delivery location");
                      return;
                    }

                    // Show loading indicator
                    $("#routeLoadingIndicator").show();
                    $("#routeResult").hide();

                    // Create form data for route optimization
                    const formData = new FormData();

                    // Get customers from selected areas instead of just area names
                    let customersToOptimize = [];
                    selectedLocations.forEach((areaName) => {
                      const areaInfo = markers[areaName];
                      if (
                        areaInfo &&
                        areaInfo.customers &&
                        areaInfo.customers.length > 0
                      ) {
                        // Add all customers from this area
                        customersToOptimize = customersToOptimize.concat(
                          areaInfo.customers
                        );
                      } else {
                        // If no specific customers found, use the area name
                        customersToOptimize.push(areaName);
                      }
                    });

                    // Add customers to form data
                    customersToOptimize.forEach((customer) => {
                      formData.append("selected_customers[]", customer);
                    });

                    console.log(
                      "Optimizing route for customers:",
                      customersToOptimize
                    );

                    // Call the server to optimize route
                    $.ajax({
                      url: "/optimize_route",
                      type: "POST",
                      data: formData,
                      processData: false,
                      contentType: false,
                      success: function (response) {
                        // Hide loading indicator
                        $("#routeLoadingIndicator").hide();

                        // Redraw map with optimized route
                        initRouteMap(response);

                        // Update route summary in the UI
                        $("#routeSummary").html(
                          `Optimal delivery order: <strong>${response.route.join(
                            " â†’ "
                          )}</strong>`
                        );

                        // Display distance and time
                        let routeSummaryHtml = `Total distance: <strong>${response.total_distance}</strong>`;
                        if (response.total_duration) {
                          routeSummaryHtml += `, Estimated time: <strong>${response.total_duration}</strong>`;
                        }
                        $("#totalDistance").html(routeSummaryHtml);

                        // Display real-time conditions affecting the route
                        let realTimeInfoHtml = "";

                        if (response.weather_conditions) {
                          realTimeInfoHtml += `
                            <div class="alert alert-info py-2 mt-2">
                              <p class="mb-1"><i class="bi bi-cloud me-2"></i><strong>Weather:</strong> ${response.weather_conditions}</p>
                            </div>`;
                        }

                        if (response.traffic_summary) {
                          realTimeInfoHtml += `
                            <div class="alert alert-warning py-2">
                              <p class="mb-1"><i class="bi bi-sign-intersection-fill me-2"></i><strong>Traffic:</strong> ${response.traffic_summary}</p>
                            </div>`;
                        }

                        if (
                          response.festival_impact &&
                          response.festival_impact !==
                            "No festivals or events affecting deliveries today"
                        ) {
                          realTimeInfoHtml += `
                            <div class="alert alert-success py-2">
                              <p class="mb-1"><i class="bi bi-calendar-event me-2"></i><strong>Events:</strong> ${response.festival_impact}</p>
                            </div>`;
                        }

                        if (realTimeInfoHtml) {
                          $("#totalDistance").after(`
                            <div id="realTimeFactors" class="mt-2">
                              <h6>Real-time conditions affecting this route:</h6>
                              ${realTimeInfoHtml}
                            </div>
                          `);
                        }

                        // Display detailed route
                        let routeDetailsHtml = "";
                        response.details.forEach(function (leg, index) {
                          // Determine traffic status badge color
                          let trafficBadgeClass = "bg-success";
                          if (leg.traffic_conditions) {
                            if (
                              leg.traffic_conditions.includes("Heavy") ||
                              leg.traffic_conditions.includes("Severe")
                            ) {
                              trafficBadgeClass = "bg-danger";
                            } else if (
                              leg.traffic_conditions.includes("Moderate") ||
                              leg.traffic_conditions.includes("Wet Roads") ||
                              leg.traffic_conditions.includes("Festival")
                            ) {
                              trafficBadgeClass = "bg-warning";
                            }
                          }

                          routeDetailsHtml += `
                            <div class="route-segment">
                              <div class="fw-bold">Leg ${index + 1}: ${
                            leg.from
                          } â†’ ${leg.to}</div>
                              <div class="mt-1">
                                <span class="badge bg-secondary me-2">Distance: ${
                                  leg.distance
                                }</span>
                                <span class="badge bg-secondary">Duration: ${
                                  leg.duration
                                }</span>
                                ${
                                  leg.traffic_conditions
                                    ? `<span class="badge ${trafficBadgeClass} ms-2">${leg.traffic_conditions}</span>`
                                    : ""
                                }
                              </div>
                              <div class="customer-address mt-2">
                                <div><small>From: ${
                                  leg.from_address
                                }</small></div>
                                <div><small>To: ${leg.to_address}</small></div>
                              </div>
                            </div>
                          `;
                        });

                        $("#routeDetails").html(routeDetailsHtml);

                        // Initialize route map using Leaflet
                        initRouteMap(response);

                        // Show the result section
                        $("#routeResult").show();
                      },
                      error: function (error) {
                        // Hide loading indicator and show error
                        $("#routeLoadingIndicator").hide();
                        alert("Failed to optimize route. Please try again.");
                        console.error("Error optimizing route:", error);
                      },
                    });
                  });
                }
              }, 100);
            }
          }
        }
      });

      // Handle chat minimize/maximize
      $("#chatMinimize").click(function () {
        const chatBody = $("#chatBody");
        if (chatBody.is(":visible")) {
          chatBody.hide();
          $(this).html('<i class="bi bi-plus-lg"></i>');
        } else {
          chatBody.show();
          $(this).html('<i class="bi bi-dash-lg"></i>');
        }
      });

      // Handle chat form submission
      $("#chatForm").submit(function (e) {
        e.preventDefault();

        const userMessage = $("#chatInput").val();
        if (!userMessage.trim()) return;

        // Add user message to chat
        $("#chatMessages").append(`
          <div class="alert alert-secondary text-end mb-2">
            <i class="bi bi-person-fill me-2"></i> ${userMessage}
          </div>
        `);

        // Clear input
        $("#chatInput").val("");

        // Scroll to bottom
        $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);

        // Add loading indicator
        const loadingId = Date.now();
        $("#chatMessages").append(`
          <div id="loading-${loadingId}" class="alert alert-light text-center mb-2">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-2">Thinking...</span>
          </div>
        `);

        // Send to backend
        $.ajax({
          url: "/chat",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({ message: userMessage }),
          success: function (response) {
            // Remove loading indicator
            $(`#loading-${loadingId}`).remove();

            // Add assistant response
            $("#chatMessages").append(`
              <div class="alert alert-info mb-2">
                <i class="bi bi-robot me-2"></i> ${response.response}
              </div>
            `);

            // Scroll to bottom
            $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
          },
          error: function (xhr) {
            // Remove loading indicator
            $(`#loading-${loadingId}`).remove();

            // Add error message
            let errorMessage =
              "Sorry, I couldn't process your request. Please try again.";
            if (xhr.responseJSON && xhr.responseJSON.error) {
              errorMessage = xhr.responseJSON.error;
            }

            $("#chatMessages").append(`
              <div class="alert alert-danger mb-2">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> ${errorMessage}
              </div>
            `);

            // Scroll to bottom
            $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
          },
        });
      });

      // Example questions
      const exampleQuestions = [
        "What are today's deliveries?",
        "What's the optimal time to deliver to Aditya?",
        "Explain the current optimized route",
        "Which areas have deliveries today?",
        "Tell me about Kabir's delivery preferences",
      ];

      // Add example question buttons
      const examplesContainer = $(
        '<div class="d-flex flex-wrap mt-2 gap-1"></div>'
      );
      exampleQuestions.forEach((question) => {
        const btn = $(
          `<button class="btn btn-sm btn-outline-secondary example-question">${question}</button>`
        );
        examplesContainer.append(btn);
      });
      $("#chatForm").after(examplesContainer);

      // Handle example question clicks
      $(".example-question").click(function () {
        const question = $(this).text();
        $("#chatInput").val(question);
        $("#chatForm").submit();
      });

      // Handle real-time data refresh
      $("#refreshRealTimeData").click(function () {
        // Show spinner in button
        const btn = $(this);
        const originalContent = btn.html();
        btn.html(
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...'
        );
        btn.prop("disabled", true);

        // Fetch fresh data
        $.ajax({
          url: "/real_time_data?type=all",
          type: "GET",
          success: function (data) {
            // Update weather card
            if (data.weather) {
              let weatherHtml = `<p class="mb-1">${
                data.weather_summary || ""
              }</p>`;

              weatherHtml += `
                <div class="d-flex align-items-center mt-2">
                  <div class="me-3">`;

              // Handle different possible temperature structures
              let temp = "N/A";
              let units = "C";
              if (data.weather.temperature) {
                if (
                  typeof data.weather.temperature === "object" &&
                  data.weather.temperature.current !== undefined
                ) {
                  temp = data.weather.temperature.current;
                  units = data.weather.temperature.units || "C";
                } else if (typeof data.weather.temperature === "number") {
                  temp = data.weather.temperature;
                }
              }

              weatherHtml += `<h3>${temp}Â°${units}</h3></div><div>`;

              // Handle conditions
              let conditions = data.weather.conditions || "Unknown";
              let humidity = data.weather.humidity || "N/A";

              weatherHtml += `
                <p class="mb-0"><strong>${conditions}</strong></p>
                <p class="mb-0 small"><i class="bi bi-droplet-half text-primary"></i> Humidity: ${humidity}%</p>`;

              // Handle precipitation data
              let precipChance = 0;
              let precipType = "precipitation";

              if (data.weather.precipitation) {
                if (typeof data.weather.precipitation === "object") {
                  precipChance = data.weather.precipitation.chance || 0;
                  precipType =
                    data.weather.precipitation.type || "precipitation";
                } else if (typeof data.weather.precipitation === "number") {
                  precipChance = data.weather.precipitation;
                }
              }

              if (precipChance > 0) {
                weatherHtml += `<p class="mb-0 small"><i class="bi bi-cloud-rain text-primary"></i> ${precipChance}% chance of ${precipType}</p>`;
              }

              weatherHtml += `</div></div>`;

              // Handle warnings
              if (
                data.weather.warnings &&
                Array.isArray(data.weather.warnings) &&
                data.weather.warnings.length > 0
              ) {
                weatherHtml += `
                  <div class="alert alert-warning mt-2 mb-0 py-2">
                    <p class="mb-0">
                      <i class="bi bi-exclamation-triangle-fill me-1"></i><strong>Warning:</strong> ${data.weather.warnings[0]}
                    </p>`;

                // Add indication if there are more warnings
                if (data.weather.warnings.length > 1) {
                  const additionalWarnings = data.weather.warnings.length - 1;
                  // Explicitly show next warning if there's only one more
                  if (additionalWarnings === 1) {
                    weatherHtml += `
                      <p class="mb-0 small mt-1">
                        <i class="bi bi-info-circle me-1"></i> ${data.weather.warnings[1]}
                      </p>`;
                  } else {
                    weatherHtml += `
                      <p class="mb-0 small mt-1">
                        <i class="bi bi-info-circle me-1"></i> ${additionalWarnings} more warning${
                      additionalWarnings > 1 ? "s" : ""
                    }
                      </p>`;
                  }
                }

                weatherHtml += `</div>`;
              }

              $("#weatherData").html(weatherHtml);
            }

            // Update traffic card
            if (data.traffic) {
              let trafficHtml = `<p class="mb-2">${
                data.traffic_summary || ""
              }</p>`;

              trafficHtml += `
                <div class="mt-3">
                  <p class="mb-1"><strong>Congestion by Area:</strong> <small class="text-muted">(Scale: 1-10, where 10 is severe)</small></p>
                  <div class="row">`;

              let areaCount = 0;

              // Check if traffic data is an object with area keys
              if (typeof data.traffic === "object" && data.traffic !== null) {
                for (const [area, areaData] of Object.entries(data.traffic)) {
                  // Skip special keys that aren't areas
                  if (area === "overall_city_congestion" || area === "status")
                    continue;

                  // Make sure areaData is an object and increment count only for valid items
                  if (typeof areaData === "object" && areaData !== null) {
                    if (areaCount >= 6) break; // Show only top 6 areas

                    // Get congestion level with fallback to 5 (medium)
                    const congestion =
                      typeof areaData.congestion_level === "number"
                        ? areaData.congestion_level
                        : 5;

                    let badgeClass = "bg-success";
                    if (congestion > 3 && congestion <= 6) {
                      badgeClass = "bg-warning";
                    } else if (congestion > 6) {
                      badgeClass = "bg-danger";
                    }

                    trafficHtml += `
                      <div class="col-6 mb-2">
                        <div class="d-flex align-items-center">
                          <div class="me-2">
                            <span class="badge ${badgeClass}">${congestion}/10</span>
                          </div>
                          <div class="small">${area}</div>
                        </div>
                      </div>`;

                    areaCount++;
                  }
                }
              }

              // If no valid areas were found, show a message
              if (areaCount === 0) {
                trafficHtml += `
                  <div class="col-12">
                    <p class="small text-muted">No area-specific traffic data available</p>
                  </div>`;
              }

              trafficHtml += `</div>`;

              // Add overall city congestion information if available
              if (
                data.traffic.overall_city_congestion !== undefined ||
                data.traffic.status
              ) {
                const overallCongestion =
                  data.traffic.overall_city_congestion || 5;

                let badgeClass = "bg-success";
                if (overallCongestion > 3 && overallCongestion <= 6) {
                  badgeClass = "bg-warning";
                } else if (overallCongestion > 6) {
                  badgeClass = "bg-danger";
                }

                trafficHtml += `
                  <div class="alert alert-secondary mt-2 mb-0 py-2">
                    <p class="mb-0 small"><strong>Overall City Status:</strong> 
                      <span class="badge ${badgeClass}">${overallCongestion}/10</span>
                      ${data.traffic.status ? ` - ${data.traffic.status}` : ""}
                    </p>
                  </div>`;
              }

              trafficHtml += `</div>`;

              $("#trafficData").html(trafficHtml);
            }

            // Update festivals card
            if (data.festivals) {
              let festivalHtml = `<p class="mb-2">${
                data.festival_summary || ""
              }</p>`;

              // Check for festival data in a safe way
              const hasFestival = data.festivals.has_festival_today === true;
              const festivalsList = Array.isArray(data.festivals.festivals)
                ? data.festivals.festivals
                : [];

              if (hasFestival && festivalsList.length > 0) {
                festivalHtml += `<div class="mt-3">`;

                const today = new Date().toISOString().split("T")[0];

                for (const festival of festivalsList) {
                  if (festival.date === today) {
                    const name = festival.name || "Event";
                    const location = festival.location || "Various locations";
                    const time = festival.time || "All day";
                    const impact = festival.traffic_impact || "Low";

                    let badgeClass = "bg-success";
                    if (impact === "Moderate") {
                      badgeClass = "bg-warning";
                    } else if (impact === "High" || impact === "Severe") {
                      badgeClass = "bg-danger";
                    }

                    festivalHtml += `
                      <div class="alert alert-success py-2 px-3 mb-2">
                        <p class="mb-1"><strong>${name}</strong></p>
                        <p class="mb-1 small"><i class="bi bi-geo-alt me-1"></i> ${location}</p>
                        <p class="mb-1 small"><i class="bi bi-clock me-1"></i> ${time}</p>
                        <p class="mb-0 small">
                          <span class="badge ${badgeClass}">${impact} impact</span>`;

                    if (
                      Array.isArray(festival.affected_areas) &&
                      festival.affected_areas.length > 0
                    ) {
                      festivalHtml += `<span class="small ms-2"><i class="bi bi-geo-fill me-1"></i>Affecting: ${festival.affected_areas.join(
                        ", "
                      )}</span>`;
                    }

                    festivalHtml += `</p></div>`;
                  }
                }

                festivalHtml += `</div>`;
              } else {
                // No festivals today - show empty state
                festivalHtml += `
                  <div class="mt-3">
                    <div class="alert alert-light py-2 px-3 mb-0">
                      <div class="text-center py-2">
                        <i class="bi bi-calendar-x text-muted" style="font-size: 2rem;"></i>
                        <p class="mb-0 mt-2">No festivals or events scheduled for today</p>
                      </div>
                    </div>
                  </div>`;
              }

              $("#festivalData").html(festivalHtml);
            }

            // Show success notification
            const timestamp = new Date(data.timestamp).toLocaleTimeString();
            $(".container").prepend(`
              <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i> Real-time data refreshed at ${timestamp}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            `);

            // Restore button state
            btn.html(originalContent);
            btn.prop("disabled", false);
          },
          error: function () {
            // Show error notification
            $(".container").prepend(`
              <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> Failed to refresh real-time data. Please try again.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            `);

            // Restore button state
            btn.html(originalContent);
            btn.prop("disabled", false);
          },
        });
      });
    </script>
  </body>
</html>
